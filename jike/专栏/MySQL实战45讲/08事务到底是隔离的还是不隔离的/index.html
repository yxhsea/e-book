<html class="cye-disabled cye-lm"><head><meta charset="utf-8"><link rel="apple-touch-icon" sizes="180x180" href="http://static001.geekbang.org/static/icon/time/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="http://static001.geekbang.org/static/icon/time/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="http://static001.geekbang.org/static/icon/time/favicon-16x16.png"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="format-detection" content="telephone=no"><title>08 | 事务到底是隔离的还是不隔离的？</title><link href="https://static001.geekbang.org/static/time/css/app.b230db929e53af87acd535637f5011b8.css" rel="stylesheet"><style id="nightModeStyle">    html.cye-enabled.cye-nm:not(*:-webkit-full-screen) body,html.cye-enabled.cye-nm:not(*:-webkit-full-screen) #cye-workaround-body {-webkit-filter:contrast(91%) brightness(84%) invert(1);}</style><style id="cyebody">html.cye-enabled.cye-lm body{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}</style><style id="cyediv">html.cye-enabled.cye-lm div{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}</style><style id="cyetable">html.cye-enabled.cye-lm th{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}html.cye-enabled.cye-lm td{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}</style><style id="cyetextInput">html.cye-enabled.cye-lm input[type=text]{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}html.cye-enabled.cye-lm textarea{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}</style><style id="cyeselect">html.cye-enabled.cye-lm select{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}</style><style id="cyeul">html.cye-enabled.cye-lm ul{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}</style><style id="cyeChangeByClick">html.cye-enabled.cye-lm .cye-lm-tag,html.cye-enabled.cye-lm.cye-lm-tag{background-color:#cce8cf !important;border-color:rgb(51, 58, 51) !important;background-image:none !important;color:#000000  !important}</style><style type="text/css">    .hljs-ln {      border-collapse: collapse    }    .hljs-ln td {      padding: 0    }    .hljs-ln-n:before {      content: attr(data-line-number)    }</style><style type="text/css">    #iv-container {      position: fixed;      background: #0d0d0d;      width: 100%;      height: 100%;      top: 0;      left: 0;      display: none;      z-index: 1000    }    .iv-container {      overflow: hidden    }    .iv-close {      width: 26px;      height: 26px;      position: absolute;      right: 20px;      top: 20px;      cursor: pointer;      text-align: center;      overflow: hidden;      text-shadow: 0 0 3px #6d6d6d;      -webkit-transition: all .2s ease;      -moz-transition: all ease .2s;      -o-transition: all ease .2s;      transition: all .2s ease    }    .iv-close:after,    .iv-close:before {      content: "";      height: 2px;      width: 26px;      background: #fff;      position: absolute;      left: 0;      top: 50%;      margin-top: -2px;      border-radius: 2px    }    .iv-close:before {      -webkit-transform: rotate(45deg);      -moz-transform: rotate(45deg);      -ms-transform: rotate(45deg);      -o-transform: rotate(45deg);      transform: rotate(45deg)    }    .iv-close:after {      -webkit-transform: rotate(-45deg);      -moz-transform: rotate(-45deg);      -ms-transform: rotate(-45deg);      -o-transform: rotate(-45deg);      transform: rotate(-45deg)    }    .iv-close:hover {      -webkit-transform: rotate(90deg);      -moz-transform: rotate(90deg);      -ms-transform: rotate(90deg);      -o-transform: rotate(90deg);      transform: rotate(90deg)    }    .iv-image-view {      position: absolute;      height: 100%;      width: 100%    }    .iv-image-wrap {      display: inline-block    }    .iv-image-wrap:active {      cursor: move    }    .iv-large-image {      cursor: move;      max-width: 100%;      max-height: 100%;      background-color: #ececec;      -moz-transform: translateZ(0);      -o-transform: translateZ(0)    }    .iv-large-image,    .iv-loader {      position: absolute;      -webkit-transform: translateZ(0);      -ms-transform: translateZ(0);      transform: translateZ(0)    }    .iv-loader {      top: 50%;      left: 50%;      border-radius: 50%;      width: 32px;      height: 32px;      z-index: 100;      margin-top: -16px;      margin-left: -16px;      font-size: 5px;      text-indent: -9999em;      border-top: 1em solid hsla(0, 0%, 100%, .2);      border-right: 1em solid hsla(0, 0%, 100%, .2);      border-bottom: 1em solid hsla(0, 0%, 100%, .2);      border-left: 1em solid #fff;      -webkit-animation: load8 1.1s infinite linear;      animation: load8 1.1s infinite linear    }    .iv-loader:after {      width: 10em;      height: 10em;      border-radius: 50%    }    @-webkit-keyframes load8 {      0% {        -webkit-transform: rotate(0deg);        transform: rotate(0deg)      }      to {        -webkit-transform: rotate(1turn);        transform: rotate(1turn)      }    }    @keyframes load8 {      0% {        -webkit-transform: rotate(0deg);        transform: rotate(0deg)      }      to {        -webkit-transform: rotate(1turn);        transform: rotate(1turn)      }    }</style><style type="text/css">    .vue-pull-to-wrapper[data-v-12abd9fb] {      display: -webkit-box;      display: -webkit-flex;      display: flex;      -webkit-box-orient: vertical;      -webkit-box-direction: normal;      -webkit-flex-direction: column;      flex-direction: column;      height: 100%    }    .scroll-container[data-v-12abd9fb] {      -webkit-box-flex: 1;      -webkit-flex: 1;      flex: 1;      overflow-y: auto;      -webkit-overflow-scrolling: touch    }    .vue-pull-to-wrapper .action-block[data-v-12abd9fb] {      position: relative;      width: 100%    }    .default-text[data-v-12abd9fb] {      height: 100%;      line-height: 50px;      text-align: center    }</style><style type="text/css">    .button-cancel[data-v-87ffcada] {      color: #888;      border: 1px solid #888;      border-radius: 3px;      margin-right: 12px    }    .button-cancel[data-v-87ffcada],    .button-primary[data-v-87ffcada] {      -webkit-box-flex: 1;      -ms-flex-positive: 1;      flex-grow: 1;      height: 35px;      display: inline-block;      font-size: 15px;      text-align: center;      line-height: 36px    }    .button-primary[data-v-87ffcada] {      color: #fff;      background-color: #ff5a05;      border-radius: 3px    }    .article[data-v-87ffcada] {      max-width: 46.25rem;      margin: 0 auto    }    .article .article-unavailable[data-v-87ffcada] {      color: #fff;      text-align: center;      font-size: .875rem;      font-weight: 400;      width: 100%;      -webkit-box-sizing: border-box;      box-sizing: border-box;      padding: 0 15%;      height: 4.9rem;      background-image: url(data:image/jpeg;base64,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);      background-position: 0 0;      background-repeat: no-repeat;      background-size: cover;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: vertical;      -webkit-box-direction: normal;      -ms-flex-direction: column;      flex-direction: column;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center;      -webkit-box-pack: center;      -ms-flex-pack: center;      justify-content: center    }    .article .main[data-v-87ffcada] {      padding: 1.25rem 1.375rem;      margin-top: 52px;      margin-bottom: 52px    }    .article-title[data-v-87ffcada] {      color: #353535;      font-weight: 400;      line-height: 1.65rem;      font-size: 1.34375rem    }    .article-info[data-v-87ffcada] {      color: #888;      font-size: .9375rem;      margin-top: 1.0625rem    }    .article-content[data-v-87ffcada] {      margin-top: 1.0625rem    }    .article-content.android video[data-v-87ffcada]::-webkit-media-controls-fullscreen-button {      display: none    }    .audio-player[data-v-87ffcada] {      width: 100%;      margin: 20px 0    }    .to-comment[data-v-87ffcada] {      overflow: hidden;      margin-bottom: -30px    }    .to-comment a.button-primary[data-v-87ffcada] {      float: right;      height: 20px;      font-size: 12px;      line-height: 20px;      padding: 4px 8px;      cursor: pointer    }    .article-comments[data-v-87ffcada] {      margin-top: 2rem    }    .article-comments h2[data-v-87ffcada] {      text-align: center;      color: #888;      position: relative;      z-index: 1;      margin-bottom: 1rem    }    .article-comments h2[data-v-87ffcada]:before {      border-top: 1px dotted #888;      content: "";      position: absolute;      top: 56%;      left: 0;      width: 100%;      z-index: -1    }    .article-comments h2 span[data-v-87ffcada] {      font-size: 15.25px;      font-weight: 400;      padding: 0 1rem;      background: #fff;      display: inline-block    }    .article-sub-bottom[data-v-87ffcada] {      z-index: 10;      cursor: pointer    }    @media (max-width:769px) {      .article .breadcrumb[data-v-87ffcada] {        padding: 10px 0      }    }</style><style type="text/css">    .share-poster-wrapper {      position: fixed;      background-color: #fff;      left: 0;      bottom: 0;      z-index: 100;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      overflow: hidden;      width: 100%;      -webkit-box-orient: vertical;      -webkit-box-direction: normal;      -ms-flex-direction: column;      flex-direction: column;      -moz-user-select: -moz-none;      -webkit-user-select: none;      -ms-user-select: none;      user-select: none    }    .share-poster-wrapper .poster-bottom,    .share-poster-wrapper .poster-middle,    .share-poster-wrapper .poster-top {      -ms-flex-negative: 0;      flex-shrink: 0    }    .share-poster-wrapper .poster-middle {      padding: 16px 32px;      -webkit-box-sizing: border-box;      box-sizing: border-box    }    .share-poster-wrapper .poster-middle .poster-userinfo {      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center;      padding-bottom: 18px    }    .share-poster-wrapper .poster-middle .poster-userinfo .poster-avatar {      min-width: 45px;      min-height: 45px;      width: 7vw;      height: 7vw;      border-radius: 50%;      -ms-flex-negative: 0;      flex-shrink: 0    }    .share-poster-wrapper .poster-middle .nickname {      font-size: 5vw;      font-weight: 400;      margin-left: 18px    }    .share-poster-wrapper .poster-middle .time {      font-size: 3.2vw    }    .share-poster-wrapper .poster-middle .poster-middle-content {      font-size: 4vw;      font-weight: 400;      white-space: normal;      word-wrap: break-word;      word-break: break-word;      letter-spacing: 1px    }    .share-poster-wrapper .poster-middle .poster-middle-content p {      margin-bottom: 22px    }    .share-poster-wrapper .poster-middle .quote-content {      font-size: 3.7vw;      padding: 32px 0    }    .share-poster-wrapper .poster-middle .quote-content p {      margin-bottom: 22px    }    .share-poster-wrapper .poster-middle .quote-info {      border-left: 1px solid #000;      padding-left: 10px;      margin-top: 38px    }    .share-poster-wrapper .poster-middle .quote-info p {      font-size: 3.2vw;      line-height: 1.5    }    .share-poster-wrapper.theme0 .poster-top {      width: 100%;      height: 25px;      margin-top: 27px;      background: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme1/top.png") no-repeat 15px 1px    }    .share-poster-wrapper.theme0 .poster-middle {      width: 100%;      padding-left: 56px;      padding-right: 56px;      background-image: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme1/middle.png");      background-repeat: repeat-y;      background-position: 15px 0    }    .share-poster-wrapper.theme0 .poster-middle .time {      margin-bottom: 45px    }    .share-poster-wrapper.theme0 .poster-middle .quote-content {      border-top: 1px solid #e3e1dc;      margin-top: 30px    }    .share-poster-wrapper.theme0 .poster-bottom {      width: 100%;      height: 25px;      margin-bottom: 27px;      background: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme1/bottom.png") no-repeat 15px -10px    }    .share-poster-wrapper.theme1 .poster-top {      width: 100%;      height: 25px;      margin-top: 27px;      background: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme0/top.png") no-repeat 38px 1px    }    .share-poster-wrapper.theme1 .poster-middle {      width: 100%;      padding: 0 42px 10px;      background: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme0/middle.png") repeat-y 38px 0    }    .share-poster-wrapper.theme1 .poster-middle .poster-userinfo {      border-bottom: 1px solid #b5a899    }    .share-poster-wrapper.theme1 .poster-middle .poster-userinfo .poster-avatar {      margin-left: 38px    }    .share-poster-wrapper.theme1 .poster-middle .poster-middle-wrapper {      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      min-height: 260px;      border-bottom: 1px solid #b5a899    }    .share-poster-wrapper.theme1 .poster-middle .time {      max-width: 65px;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: vertical;      -webkit-box-direction: normal;      -ms-flex-direction: column;      flex-direction: column;      -webkit-box-pack: center;      -ms-flex-pack: center;      justify-content: center;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center;      text-align: center;      vertical-align: middle;      border-right: 1px solid #b5a899    }    .share-poster-wrapper.theme1 .poster-middle .time span {      white-space: nowrap;      -webkit-transform: rotate(90deg);      transform: rotate(90deg)    }    .share-poster-wrapper.theme1 .poster-middle .poster-middle-content {      padding: 30px    }    .share-poster-wrapper.theme1 .poster-middle .quote-content {      font-size: 3.7vw;      margin-left: 36px;      margin-right: 36px    }    .share-poster-wrapper.theme1 .poster-middle .quote-info {      margin-left: 36px;      margin-right: 36px    }    .share-poster-wrapper.theme1 .poster-middle .footer {      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      margin-right: 30px    }    .share-poster-wrapper.theme1 .poster-bottom {      width: 100%;      height: 25px;      margin-bottom: 27px;      background: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme0/bottom.png") no-repeat 38px -10px    }    .share-poster-wrapper .share-poster {      background: #fefdf8;      -webkit-box-sizing: border-box;      box-sizing: border-box;      color: #9b8d73;      -webkit-box-flex: 1;      -ms-flex-positive: 1;      flex-grow: 1;      overflow: auto;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: vertical;      -webkit-box-direction: normal;      -ms-flex-direction: column;      flex-direction: column;      -webkit-overflow-scrolling: touch;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center    }    .share-poster-wrapper .share-poster.color0 {      background-color: #fefdf8    }    .share-poster-wrapper .share-poster.color1 {      background-color: #4d4d4d    }    .share-poster-wrapper .share-poster .footer {      margin-top: 2rem;      position: relative;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      -webkit-box-pack: end;      -ms-flex-pack: end;      justify-content: flex-end;      -webkit-box-align: end;      -ms-flex-align: end;      align-items: flex-end    }    .share-poster-wrapper .share-poster .footer p {      margin: 0;      line-height: 1.4;      margin-left: 20px;      text-align: right;      padding-right: 20px    }    .share-poster-wrapper .controls {      background: #fff;      border-top: 1px solid #f5f5f5;      width: 100%;      padding-top: 5px;      -webkit-box-shadow: 0 -4px 10px 0 rgba(0, 0, 0, .1);      box-shadow: 0 -4px 10px 0 rgba(0, 0, 0, .1);      z-index: 1;      -ms-flex-negative: 0;      flex-shrink: 0    }    .share-poster-wrapper .controls>div {      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      -webkit-box-pack: center;      -ms-flex-pack: center;      justify-content: center;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center;      padding: 10px 0    }    .share-poster-wrapper .controls>div span {      font-size: .85rem    }    .share-poster-wrapper .controls>div button {      width: 100px;      height: 24px;      background: #eee;      margin: 0 10px;      border-radius: 5px;      border: 2px solid #b2b2b2;      outline: none    }    .share-poster-wrapper .controls>div button.on {      border: 2px solid #ff5a05    }    .share-poster-wrapper .controls .controls-themes button {      color: #b2b2b2;      font-size: 12px;      background: #fff;      text-align: center    }    .share-poster-wrapper .controls .controls-themes button.on {      color: #ff5a05    }    .share-poster-wrapper .buttons {      background: #fff;      border-top: 1px solid #f5f5f5;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      -ms-flex-negative: 0;      flex-shrink: 0    }    .share-poster-wrapper .buttons a {      -webkit-box-flex: 1;      -ms-flex-positive: 1;      flex-grow: 1;      text-align: center;      color: #000;      font-weight: 400;      height: 3rem;      line-height: 3rem    }    .share-poster-wrapper .buttons a:last-child {      border-left: 1px solid #f5f5f5    }    .share-poster-wrapper img {      max-width: 100%    }    .share-poster-wrapper.android .poster-middle .nickname {      font-size: 10vw    }    .share-poster-wrapper.android .poster-middle .time {      font-size: 6.4vw    }    .share-poster-wrapper.android .poster-middle .poster-middle-content {      font-size: 8vw    }    .share-poster-wrapper.android .poster-middle .quote-content {      font-size: 7.4vw    }    .share-poster-wrapper.android .poster-middle .quote-info p {      font-size: 6.4vw    }</style><style type="text/css">    .mobile-tips {      width: 100%;      height: 51px;      background: rgba(0, 0, 0, .8);      position: fixed;      top: 0;      left: 0;      z-index: 20;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center;      -webkit-box-pack: justify;      -ms-flex-pack: justify;      justify-content: space-between;      -webkit-box-sizing: border-box;      box-sizing: border-box;      padding: 0 12px;      -webkit-transition: opacity .35s;      transition: opacity .35s;      opacity: 0;      pointer-events: none    }    .mobile-tips.istop {      opacity: 1;      pointer-events: auto    }    .mobile-tips .mobile-tips-info {      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center;      -webkit-box-pack: start;      -ms-flex-pack: start;      justify-content: flex-start    }    .mobile-tips .mobile-tips-info i {      width: 36px;      height: 36px;      background-image: url(data:image/png;base64,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);      background-position: 0 0;      background-repeat: no-repeat;      background-size: contain;      border-radius: 7px    }    .mobile-tips .mobile-tips-info h2 {      font-size: 15px;      color: #fff;      font-weight: 400;      margin-left: 6px    }    .mobile-tips .mobile-tips-info h2 span {      font-size: 11px    }    .mobile-tips a {      width: 72px;      height: 31px;      text-align: center;      border: 1px solid #ff5a05;      border-radius: 3px;      font-size: 13px;      color: #ff5a05;      line-height: 31px    }</style><style type="text/css">    .mini-audio-player {      width: 100%;      height: 5.25rem;      border: 1px solid #d9d9d9;      background: #fafafa;      -webkit-box-sizing: border-box;      box-sizing: border-box;      padding: 1rem;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center;      -webkit-box-pack: justify;      -ms-flex-pack: justify;      justify-content: space-between;      margin: 1rem 0    }    .mini-audio-player>a {      border: none;      -ms-flex-negative: 0;      flex-shrink: 0    }    .mini-audio-player .btn-play {      background-image: url(data:image/png;base64,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)    }    .mini-audio-player .btn-pause,    .mini-audio-player .btn-play {      width: 2.6875rem;      height: 2.6875rem;      background-repeat: no-repeat;      background-position: 0 0;      background-size: contain;      text-decoration: none    }    .mini-audio-player .btn-pause {      background-image: url(data:image/png;base64,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)    }    .mini-audio-player .audio-info {      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-flex: 1;      -ms-flex-positive: 1;      flex-grow: 1;      -webkit-box-orient: vertical;      -webkit-box-direction: normal;      -ms-flex-direction: column;      flex-direction: column;      margin-left: .6875rem;      min-width: 0    }    .mini-audio-player .audio-info h3 {      color: #353535;      font-size: 15.25px;      margin: 0;      white-space: nowrap;      overflow: hidden;      text-overflow: ellipsis    }    .mini-audio-player .audio-info p {      margin: 0;      margin-top: .125rem;      font-size: 11px;      line-height: 1rem    }    .mini-audio-player .audio-info p span {      color: #888    }    .mini-audio-player .btn-download {      width: 1.25rem;      height: 1.25rem;      position: relative;      background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAA+CAYAAACbQR1vAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxMzggNzkuMTU5ODI0LCAyMDE2LzA5LzE0LTAxOjA5OjAxICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+IEmuOgAAA4hJREFUaIHtm8lOFFEUhr9qCWGHGxcaY1joK2h0YRzAtYmsWbAGGidEXOACbAYRxfgAPoEPoInGxJgg86gsJTHMw86EhS7O7TDk3uqq6qo6HahvQ7pOce7//1U0feve9vr6+lAiD3QC/4AC8FZDRJXGoMB14PWB1yPANPA1bSG5tAc0XLEcu5y6CvQCOGU5pnI3agVQMWQBaAvQJgtAW4A2WQDaArTJAtAWoE0WgLYAbbIAtAVokwWgLUCbLABtAdpkAfjU6oC7wKV0pCTCRcRDnesEVwDNwC/gg/nZHbeyFOgGltj30Gw7yRZALfAOqDavPeA50BO7xOToQTR75nU14qn26Im2AM4DNZbjz4DeePQlSi+i9Sg1iLdD2AJYApYdzbuo7BBeIBptLCPeDmELYA9oBHYdjbqQpaxKowA8ddR2gXuIt0O43gRHgTu4Q+ikskIoIJps7AINwA9b0e/fYJAQ1FZWD9CP2/wOUI/DPJT+IDRqGrhCeGIEaNEPdDhqO8iVH/NrEOST4BgSwo6j3gEMBOgTNwP4m6+nhHkI/lG4VAiPgcGAveJg0IxpYxvROh6kUZi5wLhpvO2oPyKdEF6asWyEMg/hJ0PjyN+VXwhDIXuGYQh46KhtIeYnwjSMMhss3glbjvoDkglhyPS2Eck8RJ8OTyB3gl8IryL2tjGM2/wmYn4ySuNyngdMmIE3HfX7iHDPUQ+CZ3q0O+qbyIWIZB7KfyAyaQS4QmhH7oQoIZQyv0EZV75IHE+EJvG/E9oJfyd4yC6yvKO+gQQ/FaKnlbgeiU0hIWw46nnEUJAQiubbHPV1M1bZ5iHeZ4KlQmgD3uAfgofsGfQz34DsKYyFuLemTSMhfATOWOqtiMk/llrRfIuj9zpwG5gtX+Y+SezNK4bwCXsILdgDaAXOOnomYh6Seyw+gwhed9TPWY75mb9FAuYh2XWBWUS4K4QgrAE3gblYFFlIemFkDjEQJYQ1JMD5WBUdIY2VoXkkhLUQv7NqfidR85De0liYEFaRK7+QqCJDmmuDC0gIqz7nrJhzUjEP6S+O+oWwglz5xTQFaawOLwI3gO8Hjo2ZY6maB72vzPwErgEXkO8MuVaiEkcrgCK/lcfPNkhkAWgL0KYKmZiMIG9Ktn0Bx5G/wDcgXwW8R6avJ41G4HQOufInlas5ZO5+UpnJAU3AFyy7J44xe8BnoOk/JruwYo92bigAAAAASUVORK5CYII=);      background-repeat: no-repeat;      background-position: 0 0;      background-size: contain;      text-decoration: none;      padding-right: .25rem    }    .mini-audio-player .btn-download .icon-download-done {      width: .45rem;      height: .45rem;      position: absolute;      bottom: 0;      right: 0;      display: inline-block;      background-image: url(data:image/png;base64,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);      background-repeat: no-repeat;      background-position: 0 0;      background-size: contain    }</style><style type="text/css">    .MathJax_Display {      overflow: auto    }    .poster {      position: fixed;      left: -10000px;      top: -10000px;      overflow: hidden;      padding: 1rem;      background: #ececec    }    .richcontent-pre-copy {      font-size: 13px;      color: #888;      position: absolute;      right: 1em;      top: .2em;      cursor: pointer;      -webkit-user-select: none;      -moz-user-select: none;      -ms-user-select: none;      user-select: none    }    .richcontent-pre-copy .iconfont {      font-size: 12px;      margin-right: .2em    }</style><style type="text/css">    .comment-item {      list-style-position: inside;      width: 100%;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      margin-bottom: 1rem    }    .comment-item a {      border-bottom: none    }    .comment-item .avatar {      width: 2.625rem;      height: 2.625rem;      -ms-flex-negative: 0;      flex-shrink: 0;      border-radius: 50%    }    .comment-item .info {      margin-left: .5rem;      -webkit-box-flex: 1;      -ms-flex-positive: 1;      flex-grow: 1    }    .comment-item .info .hd {      width: 100%;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      -webkit-box-pack: justify;      -ms-flex-pack: justify;      justify-content: space-between;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center    }    .comment-item .info .hd .username {      color: #888;      font-size: 15.25px;      font-weight: 400;      line-height: 1.2    }    .comment-item .info .hd .control {      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center    }    .comment-item .info .hd .control .btn-share {      color: #888;      font-size: .75rem;      margin-right: 1rem    }    .comment-item .info .hd .control .btn-praise {      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center;      font-size: 15.25px;      text-decoration: none    }    .comment-item .info .hd .control .btn-praise i {      color: #888;      display: inline-block;      font-size: .75rem;      margin-right: .3rem;      margin-top: -.01rem    }    .comment-item .info .hd .control .btn-praise i.on,    .comment-item .info .hd .control .btn-praise span {      color: #ff5a05    }    .comment-item .info .bd {      color: #353535;      font-size: 15.25px;      font-weight: 400;      white-space: normal;      word-break: break-all;      line-height: 1.6    }    .comment-item .info .time {      color: #888;      font-size: 9px;      line-height: 1    }    .comment-item .info .reply .reply-hd {      font-size: 15.25px    }    .comment-item .info .reply .reply-hd span {      margin-left: -12px;      color: #888;      font-weight: 400    }    .comment-item .info .reply .reply-hd i {      color: #ff5a05;      font-size: 15.25px    }    .comment-item .info .reply .reply-content {      color: #353535;      font-size: 15.25px;      font-weight: 400;      white-space: normal;      word-break: break-all    }    .comment-item .info .reply .reply-time {      color: #888;      font-size: 9px    }</style><style type="text/css">    .breadcrumb {      padding: 30px 0;      display: -webkit-box;      display: -ms-flexbox;      display: flex;      -webkit-box-orient: horizontal;      -webkit-box-direction: normal;      -ms-flex-direction: row;      flex-direction: row;      -webkit-box-align: center;      -ms-flex-align: center;      align-items: center;      -ms-flex-wrap: wrap;      flex-wrap: wrap;      background: #fff    }    .breadcrumb a.title {      color: #e57c39;      font-size: 15px;      font-weight: 400    }    .breadcrumb span.title {      color: #888;      font-size: 15px;      font-weight: 400    }    .breadcrumb .split {      color: #ccc;      font-size: 10px;      margin-right: 5px    }</style></head><body style=""><div id="app"><div data-v-87ffcada="" class="article"><div data-v-87ffcada="" class="main main-app" style="margin-top: 0px;"><h1 data-v-87ffcada="" class="article-title">          08 | 事务到底是隔离的还是不隔离的？</h1><div data-v-87ffcada="" class="article-info"><span data-v-87ffcada="">2018-11-30</span><span data-v-87ffcada="">林晓斌</span></div><div data-v-87ffcada="" class="article-content typo common-content"><img data-v-87ffcada="" src="https://static001.geekbang.org/resource/image/d0/ec/d05de7616d91d99c3afe11ebd66497ec.jpg"><div data-v-87ffcada="" class="mini-audio-player"><a href="javascript:;" class="btn-play"></a><div class="audio-info"><h3>08 | 事务到底是隔离的还是不隔离的？</h3><p><span>朗读人：秭明&nbsp;&nbsp;&nbsp;</span><span>00:19:01 | 17849</span></p></div><audio title="08 | 事务到底是隔离的还是不隔离的？" src="https://static001.geekbang.org/resource/audio/79/5a/797668397b630849768ecf8c7393e85a.mp3" controls="controls"></audio></div><div data-v-87ffcada="" id="article-content" class=""><div class="text">              <p>我在第3篇文章和你讲事务隔离级别的时候提到过，如果是可重复读隔离级别，事务T启动的时候会创建一个视图read-view，之后事务T执行期间，即使有其他事务修改了数据，事务T看到的仍然跟在启动时看到的一样。也就是说，一个在可重复读隔离级别下执行的事务，好像与世无争，不受外界影响。</p><p>但是，我在上一篇文章中，和你分享行锁的时候又提到，一个事务要更新一行，如果刚好有另外一个事务拥有这一行的行锁，它又不能这么超然了，会被锁住，进入等待状态。问题是，既然进入了等待状态，那么等到这个事务自己获取到行锁要更新数据的时候，它读到的值又是什么呢？</p><p>我给你举一个例子吧。下面是一个只有两行的表的初始化语句。</p><pre><code>mysql&gt; CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `k` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB;
insert into t(id, k) values(1,1),(2,2);
</code></pre><p><img src="https://static001.geekbang.org/resource/image/82/d6/823acf76e53c0bdba7beab45e72e90d6.png" alt=""></p><center>图1 事务A、B、C的执行流程</center><p>这里，我们需要注意的是事务的启动时机。</p><p>begin/start transaction 命令并不是一个事务的起点，在执行到它们之后的第一个操作InnoDB表的语句（第一个快照读语句），事务才真正启动。如果你想要马上启动一个事务，可以使用start transaction with consistent snapshot 这个命令。</p><p>还需要注意的是，在整个专栏里面，我们的例子中如果没有特别说明，都是默认autocommit=1。</p><!-- [[[read_end]]] --><p>在这个例子中，事务C没有显式地使用begin/commit，表示这个update语句本身就是一个事务，语句完成的时候会自动提交。事务B在更新了行之后查询; 事务A在一个只读事务中查询，并且时间顺序上是在事务B的查询之后。</p><p>这时，如果我告诉你事务B查到的k的值是3，而事务A查到的k的值是1，你是不是感觉有点晕呢？</p><p>所以，今天这篇文章，我其实就是想和你说明白这个问题，希望借由把这个疑惑解开的过程，能够帮助你对InnoDB的事务和锁有更进一步的理解。</p><p>在MySQL里，有两个“视图”的概念：</p><ul>
<li>一个是view。它是一个用查询语句定义的虚拟表，在调用的时候执行查询语句并生成结果。创建视图的语法是create view ... ，而它的查询方法与表一样。</li>
<li>另一个是InnoDB在实现MVCC时用到的一致性读视图，即consistent read view，用于支持RC（Read Committed，读提交）和RR（Repeatable Read，可重复读）隔离级别的实现。</li>
</ul><p>它没有物理结构，作用是事务执行期间用来定义“我能看到什么数据”。</p><p>在第3篇文章<a href="https://time.geekbang.org/column/article/68963">《事务隔离：为什么你改了我还看不见？》</a>中，我跟你解释过一遍MVCC的实现逻辑。今天为了说明查询和更新的区别，我换一个方式来说明，把read view拆开。你可以结合这两篇文章的说明来更深一步地理解MVCC。</p><h1>“快照”在MVCC里是怎么工作的？</h1><p>在可重复读隔离级别下，事务在启动的时候就“拍了个快照”。注意，这个快照是基于整库的。</p><p>这时，你会说这看上去不太现实啊。如果一个库有100G，那么我启动一个事务，MySQL就要拷贝100G的数据出来，这个过程得多慢啊。可是，我平时的事务执行起来很快啊。</p><p>实际上，我们并不需要拷贝出这100G的数据。我们先来看看这个快照是怎么实现的。</p><p>InnoDB里面每个事务有一个唯一的事务ID，叫作transaction id。它是在事务开始的时候向InnoDB的事务系统申请的，是按申请顺序严格递增的。</p><p>而每行数据也都是有多个版本的。每次事务更新数据的时候，都会生成一个新的数据版本，并且把transaction id赋值给这个数据版本的事务ID，记为row trx_id。同时，旧的数据版本要保留，并且在新的数据版本中，能够有信息可以直接拿到它。</p><p>也就是说，数据表中的一行记录，其实可能有多个版本(row)，每个版本有自己的row trx_id。</p><p>如图2所示，就是一个记录被多个事务连续更新后的状态。</p><p><img src="https://static001.geekbang.org/resource/image/68/ed/68d08d277a6f7926a41cc5541d3dfced.png" alt=""></p><center>图2 行状态变更图</center><p>图中虚线框里是同一行数据的4个版本，当前最新版本是V4，k的值是22，它是被transaction id 为25的事务更新的，因此它的row trx_id也是25。</p><p>你可能会问，前面的文章不是说，语句更新会生成undo log（回滚日志）吗？那么，<strong>undo log在哪呢？</strong></p><p>实际上，图2中的三个虚线箭头，就是undo log；而V1、V2、V3并不是物理上真实存在的，而是每次需要的时候根据当前版本和undo log计算出来的。比如，需要V2的时候，就是通过V4依次执行U3、U2算出来。</p><p>明白了多版本和row trx_id的概念后，我们再来想一下，InnoDB是怎么定义那个“100G”的快照的。</p><p>按照可重复读的定义，一个事务启动的时候，能够看到所有已经提交的事务结果。但是之后，这个事务执行期间，其他事务的更新对它不可见。</p><p>因此，一个事务只需要在启动的时候声明说，“以我启动的时刻为准，如果一个数据版本是在我启动之前生成的，就认；如果是我启动以后才生成的，我就不认，我必须要找到它的上一个版本”。</p><p>当然，如果“上一个版本”也不可见，那就得继续往前找。还有，如果是这个事务自己更新的数据，它自己还是要认的。</p><p>在实现上， InnoDB为每个事务构造了一个数组，用来保存这个事务启动瞬间，当前正在“活跃”的所有事务ID。“活跃”指的就是，启动了但还没提交。</p><p>数组里面事务ID的最小值记为低水位，当前系统里面已经创建过的事务ID的最大值加1记为高水位。</p><p>这个视图数组和高水位，就组成了当前事务的一致性视图（read-view）。</p><p>而数据版本的可见性规则，就是基于数据的row trx_id和这个一致性视图的对比结果得到的。</p><p>这个视图数组把所有的row trx_id 分成了几种不同的情况。</p><p><img src="https://static001.geekbang.org/resource/image/88/5e/882114aaf55861832b4270d44507695e.png" alt=""></p><center>图3 数据版本可见性规则</center><p>这样，对于当前事务的启动瞬间来说，一个数据版本的row trx_id，有以下几种可能：</p><ol>
<li>
<p>如果落在绿色部分，表示这个版本是已提交的事务或者是当前事务自己生成的，这个数据是可见的；</p>
</li>
<li>
<p>如果落在红色部分，表示这个版本是由将来启动的事务生成的，是肯定不可见的；</p>
</li>
<li>
<p>如果落在黄色部分，那就包括两种情况<br>
a.  若 row trx_id在数组中，表示这个版本是由还没提交的事务生成的，不可见；<br>
b.  若 row trx_id不在数组中，表示这个版本是已经提交了的事务生成的，可见。</p>
</li>
</ol><p>比如，对于图2中的数据来说，如果有一个事务，它的低水位是18，那么当它访问这一行数据时，就会从V4通过U3计算出V3，所以在它看来，这一行的值是11。</p><p>你看，有了这个声明后，系统里面随后发生的更新，是不是就跟这个事务看到的内容无关了呢？因为之后的更新，生成的版本一定属于上面的2或者3(a)的情况，而对它来说，这些新的数据版本是不存在的，所以这个事务的快照，就是“静态”的了。</p><p>所以你现在知道了，<strong>InnoDB利用了“所有数据都有多个版本”的这个特性，实现了“秒级创建快照”的能力。</strong></p><p>接下来，我们继续看一下图1中的三个事务，分析下事务A的语句返回的结果，为什么是k=1。</p><p>这里，我们不妨做如下假设：</p><ol>
<li>
<p>事务A开始前，系统里面只有一个活跃事务ID是99；</p>
</li>
<li>
<p>事务A、B、C的版本号分别是100、101、102，且当前系统里只有这四个事务；</p>
</li>
<li>
<p>三个事务开始前，(1,1）这一行数据的row trx_id是90。</p>
</li>
</ol><p>这样，事务A的视图数组就是[99,100], 事务B的视图数组是[99,100,101], 事务C的视图数组是[99,100,101,102]。</p><p>为了简化分析，我先把其他干扰语句去掉，只画出跟事务A查询逻辑有关的操作：</p><p><img src="https://static001.geekbang.org/resource/image/94/49/9416c310e406519b7460437cb0c5c149.png" alt=""></p><center>图4 事务A查询数据逻辑图</center><p>从图中可以看到，第一个有效更新是事务C，把数据从(1,1)改成了(1,2)。这时候，这个数据的最新版本的row trx_id是102，而90这个版本已经成为了历史版本。</p><p>第二个有效更新是事务B，把数据从(1,2)改成了(1,3)。这时候，这个数据的最新版本（即row trx_id）是101，而102又成为了历史版本。</p><p>你可能注意到了，在事务A查询的时候，其实事务B还没有提交，但是它生成的(1,3)这个版本已经变成当前版本了。但这个版本对事务A必须是不可见的，否则就变成脏读了。</p><p>好，现在事务A要来读数据了，它的视图数组是[99,100]。当然了，读数据都是从当前版本读起的。所以，事务A查询语句的读数据流程是这样的：</p><ul>
<li>找到(1,3)的时候，判断出row trx_id=101，比高水位大，处于红色区域，不可见；</li>
<li>接着，找到上一个历史版本，一看row trx_id=102，比高水位大，处于红色区域，不可见；</li>
<li>再往前找，终于找到了（1,1)，它的row trx_id=90，比低水位小，处于绿色区域，可见。</li>
</ul><p>这样执行下来，虽然期间这一行数据被修改过，但是事务A不论在什么时候查询，看到这行数据的结果都是一致的，所以我们称之为一致性读。</p><p>这个判断规则是从代码逻辑直接转译过来的，但是正如你所见，用于人肉分析可见性很麻烦。</p><p>所以，我来给你翻译一下。一个数据版本，对于一个事务视图来说，除了自己的更新总是可见以外，有三种情况：</p><ol>
<li>
<p>版本未提交，不可见；</p>
</li>
<li>
<p>版本已提交，但是是在视图创建后提交的，不可见；</p>
</li>
<li>
<p>版本已提交，而且是在视图创建前提交的，可见。</p>
</li>
</ol><p>现在，我们用这个规则来判断图4中的查询结果，事务A的查询语句的视图数组是在事务A启动的时候生成的，这时候：</p><ul>
<li>(1,3)还没提交，属于情况1，不可见；</li>
<li>(1,2)虽然提交了，但是是在视图数组创建之后提交的，属于情况2，不可见；</li>
<li>(1,1)是在视图数组创建之前提交的，可见。</li>
</ul><p>你看，去掉数字对比后，只用时间先后顺序来判断，分析起来是不是轻松多了。所以，后面我们就都用这个规则来分析。</p><h1>更新逻辑</h1><p>细心的同学可能有疑问了：<strong>事务B的update语句，如果按照一致性读，好像结果不对哦？</strong></p><p>你看图5中，事务B的视图数组是先生成的，之后事务C才提交，不是应该看不见(1,2)吗，怎么能算出(1,3)来？</p><p><img src="https://static001.geekbang.org/resource/image/86/9f/86ad7e8abe7bf16505b97718d8ac149f.png" alt=""></p><center>图5 事务B更新逻辑图</center><p>是的，如果事务B在更新之前查询一次数据，这个查询返回的k的值确实是1。</p><p>但是，当它要去更新数据的时候，就不能再在历史版本上更新了，否则事务C的更新就丢失了。因此，事务B此时的set k=k+1是在（1,2）的基础上进行的操作。</p><p>所以，这里就用到了这样一条规则：<strong>更新数据都是先读后写的，而这个读，只能读当前的值，称为“当前读”（current read）。</strong></p><p>因此，在更新的时候，当前读拿到的数据是(1,2)，更新后生成了新版本的数据(1,3)，这个新版本的row trx_id是101。</p><p>所以，在执行事务B查询语句的时候，一看自己的版本号是101，最新数据的版本号也是101，是自己的更新，可以直接使用，所以查询得到的k的值是3。</p><p>这里我们提到了一个概念，叫作当前读。其实，除了update语句外，select语句如果加锁，也是当前读。</p><p>所以，如果把事务A的查询语句select * from t where id=1修改一下，加上lock in share mode 或 for update，也都可以读到版本号是101的数据，返回的k的值是3。下面这两个select语句，就是分别加了读锁（S锁，共享锁）和写锁（X锁，排他锁）。</p><pre><code>mysql&gt; select k from t where id=1 lock in share mode;
mysql&gt; select k from t where id=1 for update;
</code></pre><p>再往前一步，假设事务C不是马上提交的，而是变成了下面的事务C’，会怎么样呢？</p><p><img src="https://static001.geekbang.org/resource/image/cd/6e/cda2a0d7decb61e59dddc83ac51efb6e.png" alt=""></p><center>图6 事务A、B、C'的执行流程</center><p>事务C’的不同是，更新后并没有马上提交，在它提交前，事务B的更新语句先发起了。前面说过了，虽然事务C’还没提交，但是(1,2)这个版本也已经生成了，并且是当前的最新版本。那么，事务B的更新语句会怎么处理呢？</p><p>这时候，我们在上一篇文章中提到的“两阶段锁协议”就要上场了。事务C’没提交，也就是说(1,2)这个版本上的写锁还没释放。而事务B是当前读，必须要读最新版本，而且必须加锁，因此就被锁住了，必须等到事务C’释放这个锁，才能继续它的当前读。</p><p><img src="https://static001.geekbang.org/resource/image/54/92/540967ea905e8b63630e496786d84c92.png" alt=""></p><center>图7 事务B更新逻辑图（配合事务C'）</center><p>到这里，我们把一致性读、当前读和行锁就串起来了。</p><p>现在，我们再回到文章开头的问题：<strong>事务的可重复读的能力是怎么实现的？</strong></p><p>可重复读的核心就是一致性读（consistent read）；而事务更新数据的时候，只能用当前读。如果当前的记录的行锁被其他事务占用的话，就需要进入锁等待。</p><p>而读提交的逻辑和可重复读的逻辑类似，它们最主要的区别是：</p><ul>
<li>在可重复读隔离级别下，只需要在事务开始的时候创建一致性视图，之后事务里的其他查询都共用这个一致性视图；</li>
<li>在读提交隔离级别下，每一个语句执行前都会重新算出一个新的视图。</li>
</ul><p>那么，我们再看一下，在读提交隔离级别下，事务A和事务B的查询语句查到的k，分别应该是多少呢？</p><p>这里需要说明一下，“start transaction with consistent snapshot; ”的意思是从这个语句开始，创建一个持续整个事务的一致性快照。所以，在读提交隔离级别下，这个用法就没意义了，等效于普通的start transaction。</p><p>下面是读提交时的状态图，可以看到这两个查询语句的创建视图数组的时机发生了变化，就是图中的read view框。（注意：这里，我们用的还是事务C的逻辑直接提交，而不是事务C’）</p><p><img src="https://static001.geekbang.org/resource/image/ed/6e/ed4b8d03287df67ecca53b5b4830ee6e.png" alt=""></p><center>图8 读提交隔离级别下的事务状态图</center><p>这时，事务A的查询语句的视图数组是在执行这个语句的时候创建的，时序上(1,2)、(1,3)的生成时间都在创建这个视图数组的时刻之前。但是，在这个时刻：</p><ul>
<li>(1,3)还没提交，属于情况1，不可见；</li>
<li>(1,2)提交了，属于情况3，可见。</li>
</ul><p>所以，这时候事务A查询语句返回的是k=2。</p><p>显然地，事务B查询结果k=3。</p><h1>小结</h1><p>InnoDB的行数据有多个版本，每个数据版本有自己的row trx_id，每个事务或者语句有自己的一致性视图。普通查询语句是一致性读，一致性读会根据row trx_id和一致性视图确定数据版本的可见性。</p><ul>
<li>对于可重复读，查询只承认在事务启动前就已经提交完成的数据；</li>
<li>对于读提交，查询只承认在语句启动前就已经提交完成的数据；</li>
</ul><p>而当前读，总是读取已经提交完成的最新版本。</p><p>你也可以想一下，为什么表结构不支持“可重复读”？这是因为表结构没有对应的行数据，也没有row trx_id，因此只能遵循当前读的逻辑。</p><p>当然，MySQL 8.0已经可以把表结构放在InnoDB字典里了，也许以后会支持表结构的可重复读。</p><p>又到思考题时间了。我用下面的表结构和初始化语句作为试验环境，事务隔离级别是可重复读。现在，我要把所有“字段c和id值相等的行”的c值清零，但是却发现了一个“诡异”的、改不掉的情况。请你构造出这种情况，并说明其原理。</p><pre><code>mysql&gt; CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `c` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB;
insert into t(id, c) values(1,1),(2,2),(3,3),(4,4);
</code></pre><p><img src="https://static001.geekbang.org/resource/image/9b/0b/9b8fe7cf88c9ba40dc12e93e36c3060b.png" alt=""><br>
复现出来以后，请你再思考一下，在实际的业务开发中有没有可能碰到这种情况？你的应用代码会不会掉进这个“坑”里，你又是怎么解决的呢？</p><p>你可以把你的思考和观点写在留言区里，我会在下一篇文章的末尾和你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p><h1>上期问题时间</h1><p>我在上一篇文章最后，留给你的问题是：怎么删除表的前10000行。比较多的留言都选择了第二种方式，即：在一个连接中循环执行20次 delete from T limit 500。</p><p>确实是这样的，第二种方式是相对较好的。</p><p>第一种方式（即：直接执行delete from T limit 10000）里面，单个语句占用时间长，锁的时间也比较长；而且大事务还会导致主从延迟。</p><p>第三种方式（即：在20个连接中同时执行delete from T limit 500），会人为造成锁冲突。</p><p>评论区留言点赞板：</p><blockquote>
<p>@Tony Du的评论，详细而且准确。<br>
@Knight²º¹⁸ 提到了如果可以加上特定条件，将这10000行天然分开，可以考虑第三种。是的，实际上在操作的时候我也建议你尽量拿到ID再删除。<br>
@荒漠甘泉 提了一个不错的问题，大家需要区分行锁、MDL锁和表锁的区别。对InnoDB表更新一行，可能过了MDL关，却被挡在行锁阶段。</p>
</blockquote><p><img src="https://static001.geekbang.org/resource/image/ce/d9/ce7f4e35916ed1aa49206a53a0547bd9.jpg" alt=""></p></div></div></div><div data-v-87ffcada="" class="article-comments"><h2 data-v-87ffcada=""><span data-v-87ffcada="">精选留言</span></h2><ul data-v-87ffcada="">            <li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/0c/ee/7667642c.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">夏日雨</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>51</span></a></div>
	</div>
	<div class="bd">老师你好，有个问题不太理解，对于文中的例子假设transaction id为98的事务在事务A执行select（Q2）之前更新了字段，那么事务A发现这个字段的row trx_id是98，比自己的up_limit_id要小，那此时事务A不就获取到了transaction id为98的事务更新后的值了吗？<br>换句话说对于文中&quot;之后的更新，产生的新的数据版本的 row trx_id 都会大于 up_limit_id&quot;这句话不太理解， up_limit_id是已经提交事务id的最大值，那也可能存在一个没有提交的id小于up_limit_id的事务对数据进行更新？还是说transaction id比up_limit_id小的事务都是保证已经提交的？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">你的问题被引用最多，我回复你哈，其它同学看过来😄<br><br>好吧，今天的课后问题其实比较简单，本来是隐藏在思考题里的彩蛋，被你问出来了哈。<br><br>Innodb 要保证这个规则：事务启动以前所有还没提交的事务，它都不可见。<br><br>但是只存一个已经提交事务的最大值是不够的。 因为存在一个问题，那些比最大值小的事务，之后也可能更新（就是你说的98这个事务）<br><br>所以事务启动的时候还要保存“现在正在执行的所有事物ID列表”，如果一个row trx_id在这列表中，也要不可见。<br><br>虽然踩破了彩蛋，还是赞你的思考哈，置顶让大家学习😄</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">约书亚</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>29</span></a></div>
	</div>
	<div class="bd">早。<br>思考题，RR下，用另外一个事物在update执行之前，先把所有c值修改，应该就可以。比如update t set c = id + 1。<br>这个实际场景还挺常见——所谓的“乐观锁”。时常我们会基于version字段对row进行cas式的更新，类似update ...set ... where id = xxx and version = xxx。如果version被其他事务抢先更新，则在自己事务中更新失败，trx_id没有变成自身事务的id，同一个事务中再次select还是旧值，就会出现“明明值没变可就是更新不了”的“异象”（anomaly）。解决方案就是每次cas更新不管成功失败，结束当前事务。如果失败则重新起一个事务进行查询更新。<br>记得某期给老师留言提到了，似乎只有MySQL是在一致性视图下采用这种宽松的update机制。也许是考虑易用性吧。其他数据库大多在内部实现cas，只是失败后下一步动作有区别。</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">早<br><br>赞<br><br>置顶了<br><br>明天课后问题时间直接指针引用了哈😄<br><br>补充一下：上面说的“如果失败就重新起一个事务”，里面判断是否成功的标准是 affected_rows 是不是等于预期值。 <br>比如我们这个例子里面预期值本来是4，当然实际业务中这种语句一般是匹配唯一主键，所以预期住值一般是1。<br><br></p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/30/29/7d34099d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">ithunter</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>7</span></a></div>
	</div>
	<div class="bd">请教一个问题，业务上有这样的需求，A、B两个用户，如果互相喜欢，则成为好友。设计上是有两张表，一个是like表，一个是friend表，like表有user_id、liker_id两个字段，我设置为复合唯一索引即uk_user_id_liker_id。语句执行顺序是这样的：<br>以A喜欢B为例：<br>1、先查询对方有没有喜欢自己（B有没有喜欢A）<br>select * from like where user_id = B and liker_id = A<br>2、如果有，则成为好友<br>insert into friend<br>3、没有，则只是喜欢关系<br>insert into like<br><br>如果A、B同时喜欢对方，会出现不会成为好友的问题。因为上面第1步，双方都没喜欢对方。第1步即使使用了排他锁也不行，因为记录不存在，行锁无法生效。请问这种情况，在mysql锁层面有没有办法处理</div> <span class="time">2018-12-05</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">你这个问题很有趣。我想到一个不错的解法。不过我先置顶。让别的同学来回答看看。<br><br>好问题，谁有想法po出来。</p> <p class="reply-time">2018-12-06</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/05/f3/5488276f.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">心雨鑫晴</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>5</span></a></div>
	</div>
	<div class="bd">老师，我有一个问题。当开启事务时，需要保存活跃事务的数组（A），然后获取高水位（B）。我的疑问就是，在这两个动作之间（A和B之间）会不会产生新的事务？如果产生了新的事务，那么这个新的事务相对于当前事务就是可见的，不管有没有提交。</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">好问题，有很深入的思考哈<br><br>代码实现上，获取视图数组和高水位是在事务系统的锁保护下做的，可以认为是原子操作，期间不能创建事务。<br></p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/31/fe/30a17a9d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Leo</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>3</span></a></div>
	</div>
	<div class="bd">老师在文中说: &quot;所以，在执行事务 B 的 Q1 语句的时候，一看自己的版本号是 101，最新数据的版本号也是 101，可以用，所以 Q1 得到的 k 的值是 3。&quot;，<br>1. 这里不参考up_limit_id了吗？<br>2. 如果参考，事务B的up_limit_id是在执行update语句前重新计算的，还是在执行Q1语句前重新计算的？<br></div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">1. 判断可见性两个规则：一个是up_limit_id ,另一个是“自己修改的”；这里用到第二个规则<br><br>2.  这时候事务Bup_limit_id还是99</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/61/57/6f3c81dd.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">阿建</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>2</span></a></div>
	</div>
	<div class="bd">以下是一个错误的理解，在编写评论的过程中用前面刚学到的知识把自己的结论推翻，有一种快感，所以还是决定发出来。 哈哈~<br><br>事务A(100) | 事务B(101)<br>-------------------<br>             | select(1)<br>-------------------<br>             | update  <br>-------------------<br>  update  |<br>-------------------<br>              | select(2) <br>-------------------<br>事务A B在事务启动时的up_limit_id为99<br>事务B update 之后表格的每一行的row_trx_id变为101 <br>事务A 再update 之后每一行的row_trx_id变为100<br>事务B的select(2)时因为隔离级别是RR，所以去遍历的时候找row_trx_id&lt;=101的版本返回，优先找到版本为100的，就会导致select(2)并没有取到自己的更新。<br>对于对于自己的修改也认这句话和undo-log的介绍，我觉的这种情况下会获取不到自己更新的最新的数据。不知道我理解的对不对。<br><br>不对！因为事务A的update是会被行锁锁住的，而且锁是要在事务B结束之后才释放，所以不存在在事务B的update之后还在事务中被事务A给更新，导致上面的问题。</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">👍🏿<br><br>我在学习过程中也是最喜欢这种“自己推翻自己结论”的快感</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/c0/25/348b4d76.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">墨萧</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">可重复读情况下，事务c的102早于事务b的101，如果事务c再get k，那不是就取得101的值了？不太明白。</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">咱们例子里面，事务C是直接提交的，再执行一个GET 就是另外一个事务了… <br><br>如果你说的是用begin 来启动一个多语句事务，那么事务c在更新后查询，还是看到row trx_id是102的。  【注意：如果它还没提交，101根本生成不出来，因为事务B被行锁挡着呢】</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">某、人</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>28</span></a></div>
	</div>
	<div class="bd">这篇理论知识很丰富,需要先总结下<br>1.innodb支持RC和RR隔离级别实现是用的一致性视图(consistent read view)<br><br>2.事务在启动时会拍一个快照,这个快照是基于整个库的.<br>基于整个库的意思就是说一个事务内,整个库的修改对于该事务都是不可见的(对于快照读的情况)<br>如果在事务内select t表,另外的事务执行了DDL t表,根据发生时间,要嘛锁住要嘛报错(参考第六章)<br><br>3.事务是如何实现的MVCC呢?<br>(1)每个事务都有一个事务ID,叫做transaction id(严格递增)<br>(2)事务在启动时,找到已提交的最大事务ID记为up_limit_id。<br>(3)事务在更新一条语句时,比如id=1改为了id=2.会把id=1和该行之前的row trx_id写到undo log里,<br>并且在数据页上把id的值改为2,并且把修改这条语句的transaction id记在该行行头<br>(4)再定一个规矩,一个事务要查看一条数据时,必须先用该事务的up_limit_id与该行的transaction id做比对,<br>如果up_limit_id&gt;=transaction id,那么可以看.如果up_limit_id&lt;transaction id,则只能去undo log里去取。去undo log查找数据的时候,也需要做比对,必须up_limit_id&gt;transaction id,才返回数据<br><br>4.什么是当前读,由于当前读都是先读后写,只能读当前的值,所以为当前读.会更新事务内的up_limit_id为该事务的transaction id<br><br>5.为什么rr能实现可重复读而rc不能,分两种情况<br>(1)快照读的情况下,rr不能更新事务内的up_limit_id,<br>    而rc每次会把up_limit_id更新为快照读之前最新已提交事务的transaction id,则rc不能可重复读<br>(2)当前读的情况下,rr是利用record lock+gap lock来实现的,而rc没有gap,所以rc不能可重复读</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">👍🏿<br><br>本篇知识点全get</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/1f/ff/aadcf237.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Eric</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>12</span></a></div>
	</div>
	<div class="bd">我不是dba，这个课程还是需要一些基础才会更有帮助，有些章节对我来说确实看起来有些吃力，但是在坚持，一遍看不懂看两遍、三遍，同时查漏补缺的去找一些资料补充盲点，还组了个一起学习的群，希望能坚持下去，收获满满</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">赞👍🏿<br>慢慢来</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/04/b8/3fd2f448.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">lucky star</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>8</span></a></div>
	</div>
	<div class="bd">答案：<br>      分析： 假设有两个事务A和B， 且A事务是更新c=0的事务； 给定条件： 1， 事务A update 语句已经执行成功， 说明没有另外一个活动中的事务在执行修改条件为id in 1,2,3,4或c in 1,2,3,4, 否则update会被锁阻塞； 2，事务A再次执行查询结果却是一样， 说明什么？说明事务B把id或者c给修改了， 而且已经提交了， 导致事务A“当前读”没有匹配到对应的条件； 事务A的查询语句说明了事务B执行更新后，提交事务B一定是在事务A第一条查询语句之后执行的； <br><br>所以执行顺序应该是：<br>1， 事务A select * from t;<br>2,   事务B update t set c = c + 4;  &#47;&#47; 只要c或者id大于等于5就行;  当然这行也可以和1调换， 不影响<br>3,   事务B commit;<br>4,   事务A update t set c = 0 where id = c; &#47;&#47; 当前读； 此时已经没有匹配的行<br>5， 事务A select * from t;<br><br>读完第三篇后就陷入了事务执行原理的泥潭中了， 也找了不少相关资料， 但总感觉还不是特别明白， 今天看完这篇终于茅塞顿开呀， 仿佛打通了任督二脉了。。。。<br></div> <span class="time">2018-12-15</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">嗯嗯，分析得很对。<br><br>茅塞顿开的感觉很好，恭喜🎉🎈</p> <p class="reply-time">2018-12-16</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/f3/2d/711d73b2.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">薛畅</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>7</span></a></div>
	</div>
	<div class="bd">评论区的好多留言都认为 up_limit_id 是已经提交事务 id 的最大值，但是老师并未指出有何不对，这让我很困惑。<br>老师在第二版的文章中通篇未提 up_limit_id，但是文章中有这么一段话：“InnoDB 为每个事务构造了一个数组，用来保存这个事务启动启动瞬间，当前正在“活跃”的所有事务 ID。“活跃”指的就是，启动了但还没提交。数组里面事务 ID 的最小值记为低水位，当前系统里面已经创建过的事务 ID 的最大值加 1 记为高水位”。那么这个 up_limit_id 指的是不是数组里面事务 ID 的最小值，假如是的话，那么 up_limit_id 并不是已经提交事务 id 的最大值，而是活跃事物的最小值。</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">在这版里面就是用“低水位”来作为活跃的最小ID的概念，<br><br>嗯其实是为了理解原理，用了不同的表述方式哈。<br><br>后面发现上一版的描述方法太公式化了，不利于人工分析</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/49/a5/e4c1c2d4.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">qpm</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>6</span></a></div>
	</div>
	<div class="bd">这是典型的“丢失更新”问题。一个事务的更新操作被另外一个事务的更新操作覆盖。在RR状态下，普通select的时候是会获得旧版本数据的，但是update的时候就检索到最新的数据。<br>解决方法：在读取的过程中设置一个排他锁，在 begin 事务里， select 语句中增加 for update 后缀，这样可以保证别的事务在此事务完成commit前无法操作记录。参考《MySQL技术内幕 InnoDB存储引擎》</div> <span class="time">2018-12-01</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e1/09/9483f537.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">☞</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>5</span></a></div>
	</div>
	<div class="bd">老师您好：<br>    今天重新看了一下这章您的修改地方，有个地方不明白<br>    落在黄色区域未提交事务集合部分怎么还要分类，低水位+高水位不就是这个数组了吗，之前说，这个数组是记录事务启动瞬间，所有已经启动还未提交的事务ID，那不应该是未提交的事务吗，不就应该是不可读的吗<br>之前说的是启动时会获取一个最大row trx_id，所有大于这个id都不认，这个id肯定是已经提交了的事务的才对啊，这个id不才应该是数组的高水位吗，这里有点懵了</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">你设计一个“比低水位大，但是在当前事务启动前，就已经提交了的例子😄</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83epGMibYc0m7cDHMsNRBUur2NPVnlBZFXoNjWomibfjnHeAO3XRt27VaH3WNtdUX11d3uIT1ZHWCxLeg/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">york</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>5</span></a></div>
	</div>
	<div class="bd">思考题为何我做出来成功修改为0了啊？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">那就是没复现😄</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJAibnPX9jW8kqLcIfibjic8GbkQkEUYyFKJkc39hZhibVlNrqwTjdLozkqibI2IwACd5YzofYickNxFnZg/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Sinyo</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>3</span></a></div>
	</div>
	<div class="bd">原来在同一行数据，最新版本的 row trx_id 是可能会小于旧版本的 row trx_id的，这里才搞明白(惭愧脸)。。</div> <span class="time">2018-12-07</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">赞，这个想通的感觉是很爽的</p> <p class="reply-time">2018-12-07</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/6e/50/c85284da.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Sawyer</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>3</span></a></div>
	</div>
	<div class="bd">简单的总结一下：<br>1. 一致性识图，保证了当前事务从启动到提交期间，读取到的数据是一致的（包括当前事务的修改）。<br>2. 当前读，保证了当前事务修改数据时，不会丢失其他事务已经提交的修改。<br>3. 两阶段锁协议，保证了当前事务修改数据时，不会丢失其他事务未提交的修改。<br>4. RR是通过事务启动时创建一致性识图来实现，RC是语句执行时创建一致性识图来实现。</div> <span class="time">2018-12-03</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/2a/32/6354a589.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">小卡向前冲</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>2</span></a></div>
	</div>
	<div class="bd">明白了，是我之前对高低水位的定义没有搞清楚：RR隔离级别下，事务A在执行Select时，要重算read-view,此时数组是[99, 100, 101]，系统最大事务id是102，故低水位是99，高水位是102+1=103。<br>这样就可以推出来了~~</div> <span class="time">2018-12-12</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这回理解到位了😄</p> <p class="reply-time">2018-12-12</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/53bf91d3.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">WL</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>2</span></a></div>
	</div>
	<div class="bd">想请教一下老师, 在数据可见性规则那一部分中的第三种可能的b情况: &quot;若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见。&quot;对于这部分内容我开始不是很理解, 后来反复思考了一下, 可见性规则这部分是不是在说明这种情况:  因为数据的row trx_id是依次递增的, 但是事务由于创建和提交的时间不可预期所以transactionId可能是跳跃的, 所以假如有事务A, 比A的transactionId大的数据的row trx_id对于事务A一定不可见, 但是比A的transactionId小的数据的row trx_id也可能在A的事务数组中, 所以要判断一次. 不知道这么理解对不对?</div> <span class="time">2018-12-08</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是的，最后这个“可能”说得很好，<br>可能在，也可能不在，就用“是否在数组中”来判断</p> <p class="reply-time">2018-12-09</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/c6/e4/ec572f55.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">沙亮亮</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>2</span></a></div>
	</div>
	<div class="bd">买了很多专栏，丁奇老师绝对是为读者考虑最为细致的，不管是从回复大家的提问，还是从学习者角度考虑优化文章内容，最后到思考题的讲解，都是最细致的</div> <span class="time">2018-12-07</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">谢谢你，我倍受鼓舞呀😄</p> <p class="reply-time">2018-12-07</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">信信</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>2</span></a></div>
	</div>
	<div class="bd">老师您好，有处疑问，文中说：“对于图 2 中的数据来说，如果有一个事务，它的低水位是 18，那么当它访问这一行数据时，就会从 V4 通过 U3 计算出 V3。”看上去像是一定会取小于低水位的值。那假如我的事务id是27，活跃数组是18，19，26，这样的话事务id为25的数据我也认呀。恳请老师解惑。</div> <span class="time">2018-12-04</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/29/8e/f6241f28.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">欧阳波</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>2</span></a></div>
	</div>
	<div class="bd">老师好 我是一个java开发 看了前面文章 提到 清空索引空间问题 我们现在得表所有的删除都用truncate 不用delete是否合理</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">如果业务上是接受清空的，truncate没问题😄</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e0/b9/bca7ff9a.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">way</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>2</span></a></div>
	</div>
	<div class="bd">MySQL分为当前读和快照读。一般情况下，select是快照读，dml操作是当前读。RC和RR的区别就是创建read view 的时间不一样。rc在每个当前读的时候创建，rr在事物开始的时候创建。<br>之前遇到个问题，请老师帮忙解答下。<br>rr 隔离级别<br>数据demo <br>a b 都不是主键。b 上有普通索引<br>-------<br>a b<br>-------<br>1 2<br>10 5<br>-----<br>#session 1<br>select * from t where a = 10 ;<br>b=5<br>#session 2<br>select * from t where a = 10 ;<br>b=5<br>#session 1<br>update t set b = 100 where a = 10 ;<br>rows matched 1 effect 1 change 1<br>select * from t where a = 10 ;<br>#b = 100<br>#session 2 <br>update t set b = 100 where a = 10 ;<br>--阻塞，等session 1 commit 以后<br>rows matched 1 effect 0 change 0<br>此时<br>#session 2 <br>select * from t where a = 10 ;<br>结果是 b = 10 <br>在mysql 8.0 里面测试，session2 最后的值是100 。percona server 5.7.18一下是 10 ，所以这是低版本的bug 对吧？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是不是执行过程有误，整个过程里面并没有把b 赋值成10过，怎么会查出来10？</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/f8/70/f3a33a14.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">某、人</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>2</span></a></div>
	</div>
	<div class="bd">接上一篇更正:<br>rc不是没有gap.情况稍显复杂,基本上就是replace和insert有唯一索引的情况加next-key lock(还分X和S)<br>老师我有个问题:<br>假如A开启事务up_limit_id为100,B开启事务up_limit_id为110,C开启事务up_limit_id为120<br>A trx101   <br>select ;      B tid111<br>                   select;             C tid121<br>			                 update;<br>update                              commit;<br>commit;                             <br>                  select;<br>C最先把row tid改写为121,A随后把该行的row tid更改为101.那么B第二次去判断110&gt;101,那不是就能查到A更改的数据了？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">👍🏿<br><br>看一下置顶评论里面我的一个回复哈</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/f3/89/fcfecb46.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">我爱学习</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">老师，您说：<br>对于可重复读，查询只承认在事务启动前就已经提交完成的数据；<br>那么为什么不能避免幻读呢<br><br>还有一种现象：<br>当前事务x中查询出a值为1，另外一个事务将a值加一，当前事务查询到a值仍然为一，但是如果在当前事务对a update加一，查询出来的a就变成3了</div> <span class="time">2018-12-14</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这个就是文中的session B 不是？<br><br></p> <p class="reply-time">2018-12-14</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/b8/36/542c96bf.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Mr.Strive.Z.H.L</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">这个必须要单独回复一下老师：<br>我的所有留言老师都一一回复，问题全部都解释的很清楚。在学校其实mysql用的非常简单，真的要说一下这个课实在太好了，把原理讲得简单易懂，并且评论里的讨论加深了自己的认知。<br>所以真的很感谢老师~~感谢感谢</div> <span class="time">2018-12-12</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">也谢谢你，说明你的问题质量高哦。<br><br>其实我没有回复大家所有的评论，<br>不过问得认真详细的、又跟其他同学问题不重复的问题，我会尽量全部回复，<br><br>因为把问题问清楚本身是要花心思的，不能辜负呀<br><br><br></p> <p class="reply-time">2018-12-12</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/c5/5e/24cc5a72.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">阿狸爱JAVA</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">只是理解一下这感觉身体被掏空，如果为我自己去实现这样的功能，我只想静静，何况我看到的只是冰山一角。不得不说很佩服👍</div> <span class="time">2018-12-12</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/b8/36/542c96bf.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Mr.Strive.Z.H.L</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">关于之前的疑惑：<br>之前问了个问题，老师的答复是：行锁一般不是sql语句指定的，在innodb自动加的。<br>那 sql语句中 ...... for update 这个语法，不就是上锁吗？。<br>这个锁和innodb加的锁是什么关系？？<br><br>我自己的猜测答案：<br>在隔离级别处于可重复读：innodb为了防止并发更新，针对更新的数据都会自动加上行锁。那么实际上两个事务同时执行update同一条语句的操作，是不会发生并发问题的。业务上写的sql语句加上了for update是为了保证 “当前读”，读到最新的数据。因为如果没有for update，应该是读不到当前数据的，而是处于 “快照读”。<br>所以总结一下：for update主要是为了读取到最新数据，即使没有for update，但是只要两个事务同时更新同一条数据，那么就必然会有阻塞等待的过程。<br>我这么理解对吗？</div> <span class="time">2018-12-12</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">哦，好吧，第一段你说的对，还有select ... for update, 我之前回复的时候误以为你只是说update语句哈<br><br>第二段也对。update 和select... for update都会加行的写锁，都不能并发的</p> <p class="reply-time">2018-12-12</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/2a/32/6354a589.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">小卡向前冲</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">老师你好，我有一点不太明白：提交的例子中，事务A进行查询时，事务B未提交，事务C已提交；那么，此时事务A的read-view 数组是多少呢？按照文章中的说法，我认为应该还是[99, 100]，但是这样无法推出查询结果是2。<br>请问，我是在哪里理解有误么？另，看评论中有人提到了up_limit_id 这个值在文中似乎没有提及，但是如果引入这个变量的话，就可以解决我上面的问题了。</div> <span class="time">2018-12-11</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">[99,100,101], 高水位是103，还是可以推得出来的吧</p> <p class="reply-time">2018-12-11</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/cb/50/66d0bd7f.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">杰之7</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">这讲的内容是前面事务和锁的综合，没有前面的知识结构，不可能对这讲的原理和过程有清晰的认识。通过这讲的学习，先写下这讲最经典的两句话，一，可重复读，查询只承认在事务启动前就就已经提交完成的数数据。二、对于读提交，查询只承认在语句启动前就已经提交完成的数据。第一句话解释的老师文章开始抛给我们的问题，也就是为什么是1的原因。第二句话解释在读提交状态下，为什么是2的原因。当然，老师还分析了更新逻辑，对于更新数据先读后写，读是读当前值，这就解释了为什么第二个事物是3的原因。在事物C‘这种情况西，只能等事物C‘释放后，才会继续读，这样将事务和锁的知识又联系的起来。写的感受，这篇文章是我目前为止能力之中感受到最好的一篇文章，还挺难，但我能搞定它。</div> <span class="time">2018-12-09</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">👍🏿，总结得不错</p> <p class="reply-time">2018-12-09</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/ba/48/c892a35b.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">崔根禄</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">老师，<br>这两天反复读这篇文章，想到一个业务上的问题：减库存的场景<br>当前库存：num=200<br>假如多线程并发：<br>AB同时开启事务，A先请求到行锁，<br>A：<br>start transaction;<br>select num from t where num&gt;0;先查询当前库存值（num&gt;0）<br>update t set num=num-200; 库存减量<br><br>B：<br>start transaction;<br>select num from t where num&gt;0;先查询当前库存值（num&gt;0）<br>update t set num=num-200; 库存减量<br>----结果---<br>A：查询到num=200,做了库存减量成了0<br>B：事务启动后，查询到也是200，等 A 释放了行锁，B进行update，直接变成 -200<br>但是 B 查询时，时有库存的，因此才减库存，结果变成负的。<br>老师，对于这种场景，怎么避免减成负值？<br>给 select 加读锁或者写锁吗 ？这种select 加锁，对业务影响大吗？<br></div> <span class="time">2018-12-07</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这是个好问题，也是并发业务常见的问题。<br><br>一开始Select 加锁虽然可以，但是会比较严重地影响并发数。<br><br>比较简单的做法是update语句的where 部分加一个条件： where nun &gt;=200 .<br>然后在程序里判断这个update 语句的affected_rows, <br>如果等于1 那就是符合预期；<br>如果等于0，那表示库存不够减了，业务要处理一下去，比如提示“库存不足”</p> <p class="reply-time">2018-12-08</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/87/dd/4f53f95d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">进阶的码农</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">文中黄色区域不就是代表当前事务启动时的活跃数组吗，因为黄色区域两个边界是低水位和高水位。既然这样怎么会有 row tx_id在黄色区域 但是又不在数组里的情况呢。是我理解的有问题吗 请指教</div> <span class="time">2018-12-07</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">黄色区域只是高水位和低水位之间，但是不是连续自然数集合哦</p> <p class="reply-time">2018-12-07</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/4a/45/04a13bf9.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">bing</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">当行记录的事务ID在活动范围之中时，判断是否在活动链表中，如果在就不可见，如果不在就是可见的。<br>　　for (i = 0; i &lt; n_ids; i++) {<br>　　　　trx_id_t view_trx_id<br>　　　　　　= read_view_get_nth_trx_id(view, n_ids - i - 1);<br>　　　　if (trx_id &lt;= view_trx_id) {<br>　　　　return(trx_id != view_trx_id);<br>　　　　}<br>　　}<br><br>新建事务(当前事务)与正在内存中commit 的事务不在活跃事务链表中。<br>新建事务(当前事务)与正在内存中commit 的事务不在活跃事务链表中。<br>新建事务(当前事务)与正在内存中commit 的事务不在活跃事务链表中。<br>求解释<br><br></div> <span class="time">2018-12-06</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/fa/61/691e2936.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">算不出流源</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">“InnoDB 里面每个事务有一个唯一的事务 ID，叫作 transaction id。它是在事务开始的时候向 InnoDB 的事务系统申请的，是按申请顺序严格递增的。”<br><br>老师您好，请问是begin&#47;start transaction语句就申请到了trx_id，还是执行了第一个操作数据表的语句才有了trx_id呢？</div> <span class="time">2018-12-05</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">都是“事务启动”的时候申请，<br><br>所以是第一个操作表的语句。<br><br>也可以是执行start transaction with consistent snapshot这个语句的时候</p> <p class="reply-time">2018-12-05</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e1/09/9483f537.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">☞</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">老师回复“你设计一个“比低水位大，但是在当前事务启动前，就已经提交了的例子😄”<br>我意思说比低水位大的肯定是已经提交的事务啊，这样的话黄色区域肯定都是已经提交的事务啊，为什么还要区分已经提交和还没有提交的事务呢？应该都是不可读的才对吧<br>如果是RC的话，可以理解成每次读之前会再去黄色区域看看有没有提交，但是RR应该就不会再去读黄色区域了才对</div> <span class="time">2018-12-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">比低水位大的不一定已经提交了哦<br><br>比如一个事务启动时当前活跃事务是[99,100,102], 而101已经提交了</p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/53bf91d3.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">WL</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">把该讲内容总结为几个问题, 大家复习的时候可以先尝试回答这些问题检查自己的掌握程度:<br><br>	1. <br>MySQL中的两个视图分别应该如何理解?<br>	2. <br>row trx_id 和 up_limit_id的定义是什么?<br>	3. <br>MVCC的实现机制是怎样的?<br>	4. <br>一致性读的概念是什么? 事务的可重复读是怎么毅力一致性读实现的?<br>	5. <br>当前读的概念是什么? 什么语句会采用当前读的机制?<br><br></div> <span class="time">2018-12-01</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">往事随风，顺其自然</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">row Trx-id不是最大的就是最新版本，但是rc时候最大up-limit-id,102都成为历史版本，还读取，感觉好奇怪，如果c在执行一个事物读到的数据?怎么知道那个数据是最新版本，因为最新版本数据对应的row Trx-id并不是最新数据</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这个问题没看明白…</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/d5/ee/762ca3f9.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">🚶🏻_____路人丙</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">老师你好第一次提问不是dba，有个疑问，事务不是先拿到锁的先执行么，为啥图3，事务C先执行？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/06/dc/1a504e09.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">周巘</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">老师好 我想请问一下 如果文章中99号事务提交了 98号事务还没有提交 那么这三个事务的up_limit_id应该还是99 然后在事务A(id=100)的两次读过程中 98号事务提交并且修改了这一行 此时row trx_id=98 将会小于up_limit_id=99 那么事务A的两次读请求结果不就不一样了吗? 请老师解惑 谢谢<br><br></div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">看一下置顶评论答复哈</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/34/5c/6b4757a0.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">倪大人</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">对于读提交，查询只承认在语句启动前就已经提交完成的数据；<br>而当前读，总是读取已经提交完成的最新版本。<br><br>老师请问下读提交和当前读有什么区别吗，我理解这两个都是读到已提交的最新版本？如果是的话，那为什么读提交这种隔离级别不直接基于当前读做呢，每次去算一下up_limit_id不麻烦吗o.o</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">不一样，读提交隔离级别下，首先是不加锁的。<br><br>还有，你考虑下，一个语句开始执行的之后，执行期间别的事务修改了数据的情况<br><br>PS： 这是个好问题</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/48/bd/6c7d4230.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Tony Du</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">在RR隔离级别下，对于文中的例子，“所以，在执行事务 B 的 Q1 语句的时候，一看自己的版本号是101，最新数据的版本号也是101，可以用，所以 Q1 得到的 k 的值是3”，<br>这里事务B的 up_limit_id 应该还是99，此时数据的最新版本是101，则这里通过up_limit_id判断数据可见性原则是不适用的（如果Q1能够看到k=3），那是否还有其他的数据可见性原则？（比如当自己修改过数据之后，看一下自己当前transaction的版本号？）<br>如果存在多个数据可见性原则，那这些原则的优先级是怎么样的（即先用哪条原则，后用哪条原则），请老师解惑。<br></div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">自己改的要看到，事务启动时还没提交的看不到<br><br>理解上可以认为就这两条</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/6c/02/cdeeea90.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">稳</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">思考题：<br>事务A：<br>       begin;<br>       select * from t;<br>       &#47;*<br>        *这个时候执行了事务B<br>      *&#47;<br>       update t set c=0 where id=c;<br>       select * from t;<br>事务B：<br>     update set c = 0 where id = c;<br><br>有一个疑问，对于可重复读，查询应该是只承认事务中第一个查询语句前已经提交完成的数据吧。</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">准确描述是“事务启动时”</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/48/b2/cca85581.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">小文</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">老师您好，事务启动是begin就记录up_limit_id还是begin之后的第一条select语句开始记录up_limit_id?我测试中，客户端A 执行begin后但没执行select，客户端B开始事务修改提交后，客户端A再次select会读到这个修改值。而另一种begin后直接select,此后客户端B开始事务修改后，客户端Aselect就是第一次Select的值。</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">Begin之后的第一个语句算启动事务<br><br></p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/0b/78/22410c47.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">魏春河</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">思考题：<br>   begin<br>   up_limit_id = 100;<br>   1. select (row trx_id = 100)<br>        这里另外一个事务里执行了 set c= 0 where id = c 并提交；trx_id = 102;<br>  2 . update 执行(当前读) ，所以找不到符合条件的数据。<br><br> 3. select <br>     up_limit_id 依然是 100；<br><br>所以结果就如思考题中截图所示。<br>   </div> <span class="time">2018-11-30</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">小四</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>1</span></a></div>
	</div>
	<div class="bd">显然地，语句 Q1 的查询结果 k=1。这个测试后发现是3？请老师确认下</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是1，手误抱歉。<br><br>👍🏿一边看一边验证哈</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/d9/49/09691c94.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">唐国舜</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">“在实现上， InnoDB 为每个事务构造了一个数组，用来保存这个事务启动瞬间，当前正在“活跃”的所有事务 ID。“活跃”指的就是，启动了但还没提交。”<br>“如果落在黄色部分，那就包括两种情况<br>a. 若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见；<br>b. 若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见”<br>老师新年好，这两段话有点矛盾，前一段定义了“活跃”事务是启动了但还没提交，后面一段又说不在数组中是已经提交了的事务生成，那么黄色段是个区间还是活跃事务数组呢？从后面解释来理解是个区间，谢谢老师解答。</div> <span class="time">2019-02-10</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">新年好<br><br>好问题<br>这两个概念的关系是：<br>视图数组是活跃事务ID的集合，这个集合里，最小的事务id记为Min_id, 最大的事务id记为Max_id<br>黄色区间就是 [Min_id, Max_id] 这个区间<br><br>PS：Min_id就是低水位</p> <p class="reply-time">2019-02-11</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/24/cf/064ce4ac.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">evil</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师你好，在这一章我有几个问题想确认，在隔离级别为consistent read<br>1.当删除表里面数据的时候，官方文档说该行数据不会立刻删除而是，会进行一个标记删除， 但是官方文档里面说，每一行只有三个隐藏字段 ，6-byte DB_TRX_ID ， 7-byte DB_ROLL_PTR，6-byte DB_ROW_ID，请问哪个字段是来表示删除的，或者说还是由另外的一个文件再维护？<br>2.当一个表里面存在非聚合索引的时候，因为做的是标记删除，当某个事务去做查询的时候，如何知道该行数据已经删除了，每个非聚合索引每一个索引数据都会有一个标示位吗？</div> <span class="time">2019-02-09</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">1. 这三个字段都不是用来表示“删除”的，删除就是delete mark，标记在数据上<br>2. 是的</p> <p class="reply-time">2019-02-11</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/74/75/4bf3a04b.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">赵孔胜</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">请教一个问题，业务上有这样的需求，A、B两个用户，如果互相喜欢，则成为好友。设计上是有两张表，一个是like表，一个是friend表，like表有user_id、liker_id两个字段，我设置为复合唯一索引即uk_user_id_liker_id。语句执行顺序是这样的：<br>以A喜欢B为例：<br>1、先查询对方有没有喜欢自己（B有没有喜欢A）<br>select * from like where user_id = B and liker_id = A<br>2、如果有，则成为好友<br>insert into friend<br>3、没有，则只是喜欢关系<br>insert into like<br><br>如果A、B同时喜欢对方，会出现不会成为好友的问题。因为上面第1步，双方都没喜欢对方。第1步即使使用了排他锁也不行，因为记录不存在，行锁无法生效。请问这种情况，在mysql锁层面有没有办法处理<br><br>-----<br><br>关于这个问题，之前遇到过一个面试题有点类似，我想到的方案是，like表的结构可以类似<br>```<br><br>CREATE TABLE `like` (<br>	`less_userid` BIGINT(20) NOT NULL DEFAULT &#39;0&#39;,<br>	`greater_userid` BIGINT(20) NOT NULL DEFAULT &#39;0&#39;,<br>	`like_flag` BIGINT(20) NOT NULL DEFAULT &#39;0&#39;,<br>	PRIMARY KEY(`less_userid`,`greater_userid`)<br>) ENGINE=InnoDB;<br><br><br>```<br>，当然也可以用`less_userid`和`greater_userid`字段建唯一索引，而不是主键。<br><br>`less_userid`表示更小的userid， `greater_userid`表示更大的userid，`like_flag`表示谁like谁，例如1表示`less_userid` like `greater_userid`，2表示`greater_userid` like `less_userid`，3表示互相like。每个like都是直接插入，如果发现唯一键冲突，update `like_flag`，取或运算，如果`like_flag`等于3，说明互相like了。<br></div> <span class="time">2019-02-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">👍<br><br>这个跟我文章的方案是不是差不多的？<br>不过把字段名改成 less_userid 和 greater_userid，确实更好理解了哦。<br>新春快乐~</p> <p class="reply-time">2019-02-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/be/d4/ff1c1319.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">金龟</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，我有2问题:<br>1:当启动事务的时候，我们生成一致性视图数组（低水位，活跃，高水位），如果后面有新的事务生成或者提交 这个数组会变动吗?<br>2:老师这堂课应该只是讲的是rr的处理方式，如果是rc，当前事务是怎么查看到 在当前事务处理过程中提交的事务呢?</div> <span class="time">2019-02-02</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">新春快乐~<br>你这两个问题刚好是一起的^_^<br><br><br>1. 在RR隔离级别，不会；<br>2. 如果是RC，那么每次语句执行的时候，重新生成一次一致性视图</p> <p class="reply-time">2019-02-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/e7/5d/a99d32d5.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">绿里奇迹</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">版本已提交，但是是在视图创建后提交的，不可见<br>那为什么第一个例子中的事务B能够读到事务C的更改。<br>事务C的提交在事务B start transaction with...之后。</div> <span class="time">2019-01-31</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">本来是看不见的，<br>但是session B的update语句把数据改了（注意，在update的时候是当前读），<br>改完以后，这个记录上的事务id就变成B的事务id。<br>之后事务B执行select的时候，发现这个记录是自己更新的，就要可见</p> <p class="reply-time">2019-01-31</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/d9/49/09691c94.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">唐国舜</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">清楚了，老师厉害，之前只陷入前半部分，没看后面的当前读，觉得有脏读的矛盾</div> <span class="time">2019-01-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">👍</p> <p class="reply-time">2019-01-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/d9/49/09691c94.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">唐国舜</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">好，现在事务 A 要来读数据了，它的视图数组是 [99,100]。当然了，读数据都是从当前版本读起的。所以，事务 A 查询语句的读数据流程是这样的：<br><br>找到 (1,3) 的时候，判断出 row trx_id=101，比高水位大，处于红色区域，不可见；<br>接着，找到上一个历史版本，一看 row trx_id=102，比高水位大，处于红色区域，不可见；<br>再往前找，终于找到了（1,1)，它的 row trx_id=90，比低水位小，处于绿色区域，可见。<br>老师，能说明一下事务b的找数过程吗？比如事务b中先是update语句怎么找，接着是select怎么找，我现在卡在这节没理解，谢谢<br></div> <span class="time">2019-01-29</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/08/36/98be3d69.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">奋斗心</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">思考题：不理解由于update t set c = id + 1 能实现效果。即使由于CAS原因导致update t set c=0 where id = c失败。update t set c = id + 1 这句不应该执行成功了吗？意思是说update t set c=0 where id = c失败后，update t set c = id + 1  会回滚？</div> <span class="time">2019-01-28</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/40/5e/b8fada94.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Ryoma</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">在8.0的文档中：SELECT ... FOR SHARE is a replacement for SELECT ... LOCK IN SHARE MODE, but LOCK IN SHARE MODE remains available for backward compatibility. The statements are equivalent.<br><br>和for update格式保持一致，也更容易理解了。</div> <span class="time">2019-01-25</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是的，以前那个写法太啰嗦了😄</p> <p class="reply-time">2019-01-25</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/d9/49/09691c94.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">唐国舜</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，请教下面您说的这句话“接着，找到上一个历史版本，一看 row trx_id=102，比高水位大，处于红色区域，不可见；”事务a的视图数组是[99,100],按照已提交的在绿色区域（已提交或者事务自己改的都在绿色区域）的话，这时应该能读trx_id=102的吧？为何处于红色区域</div> <span class="time">2019-01-25</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">不是 “已提交的在绿色区域” 哦<br><br>而是 “在事务a启动的时候，已提交的在绿色区域”。<br>在事务a启动的时候， 102这个事务还没提交的。</p> <p class="reply-time">2019-01-25</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/d9/49/09691c94.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">唐国舜</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">我还有点疑问请教老师，事务c是立刻commit，表里变成2，分两种情况讨论：<br>场景1:如果隔离级别是RC，那么b的update看到的也是2，将它更新成3，再select出来3，但还没commit，而a只能看到c提交的2<br><br>场景2:如果隔离级别是RR，那么b的update看到的也是1，将它更新成2，再select出来2，但还没commit，而a只能看到c未提交的1</div> <span class="time">2019-01-24</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这个解释是对的呀<br>图1我们就是在RR下讨论的。<br></p> <p class="reply-time">2019-01-24</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/4c/3b/7b9adb75.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">凯</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师在置顶帖@夏日雨的提问中回答说到，所有事物启动时还要保存“现在正在执行的所有事物ID列表”，不明白这里所说的正在执行的和文章中提到的‘当前正在“活跃的”所有事物ID’，这两者之间有什么区别呢？“正在执行”和“当前活跃的”区别在哪里？</div> <span class="time">2019-01-24</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">没区别， 当前活跃的事务id列表，就是视图数组</p> <p class="reply-time">2019-01-24</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/d9/49/09691c94.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">唐国舜</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">第二个有效更新是事务 B，把数据从 (1,2) 改成了 (1,3)。这时候，这个数据的最新版本（即 row trx_id）是 101，而 102 又成为了历史版本。，老师，我对这个还没理解，读一致性从事务开始算，事务a看到1可以理解，但事务b是更新后再读，在事务开始时【99-101】，更新时要再读一次吧，要不怎么感知到102的事务？</div> <span class="time">2019-01-24</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">你说的“更新时要再读一次吧”是指再更新一次事务的视图数组吗？<br><br>更新的时候，如果更新成功，最新版本会使用“当前事务的id”，所以能看到；<br><br>如果更新没成功，就看不到了。<br><br>所以并没有“再读一次”哦</p> <p class="reply-time">2019-01-24</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/b2/5a/574f5bb0.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Lukia</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">请教老师，文中提到在MySQL的RR隔离级别下的当前读用到了锁，请问这样是否可以避免在postgres之类没有使用当前读来实现RR隔离级别的数据库中产生的写偏序问题？</div> <span class="time">2019-01-23</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">你给我举个例子吧^_^ 以防我对pg概念理解偏差回答错误哦</p> <p class="reply-time">2019-01-23</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/cd/2a/bdbed6ed.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">无菇朋友</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师请教一个问题，事务A启动时，当前活动事务列表包不包括自己的trx_id</div> <span class="time">2019-01-23</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">实现上不包括<br>不过无所谓的，因为如果是自己更新的，总是可见的</p> <p class="reply-time">2019-01-23</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/cd/2a/bdbed6ed.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">无菇朋友</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">最高赞的老哥的问题，不就是对应着3(a)的情况</div> <span class="time">2019-01-21</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">忽略这个哈，因为这篇文章后来重写了<br>一楼的同学很认真，他看过上一个版本的，这个问题是基于上一个版本的😆</p> <p class="reply-time">2019-01-21</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/8e/e2/1e70c61d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">阿邱</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">2.版本已提交，但是是在视图创建后提交的，不可见；<br>写东西能不能逻辑清晰一点？什么叫视图创建后提交？问题来源在哪里？必须每一点都逻辑清楚，中途断片别人怎么看得下去？</div> <span class="time">2019-01-21</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是在“视图创建”这个时刻之后，才提交的，所以不可见。<br><br>看文章的时候心态要平和，否则其实是浪费自己的时间，并没有什么好处的</p> <p class="reply-time">2019-01-21</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/8e/e2/1e70c61d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">阿邱</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">按理说前面的事务id应该小啊，怎么还大呢？</div> <span class="time">2019-01-21</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这个问题的上下文是？</p> <p class="reply-time">2019-01-21</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/8e/e2/1e70c61d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">阿邱</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">文章很难让人读懂，真费劲，写技术文档必须每个字都非常严谨，否则别人很难读懂，你自己当然读得懂，或者直接举个简单现实更容易懂些，看技术文档还得自己看一些原始的东西，很难跟上别人的思路，除非写的很通俗易懂。</div> <span class="time">2019-01-21</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是指哪些段落呢？<br>这篇文章我是重写过三次了，其他同学的反馈来看还是可以的<br>把你不清楚的地方指出来吧，<br>可能有时候只是一个点卡住了而已</p> <p class="reply-time">2019-01-21</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Zzz</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师。我看到&quot;某、人&quot;同学说“一个事务要查看一条数据时,必须先用该事务的up_limit_id与该行的transaction id做比对,如果up_limit_id&gt;=transaction id,那么可以看...&quot;, &quot;什么是当前读,由于当前读都是先读后写,只能读当前的值,所以为当前读.会更新事务内的up_limit_id为该事务的transaction id&quot;。关于“更新事务up_limit_id”这个说法，我有疑惑，我做了以下的实验（MySQL 5.7.14）：表t原始数据(7,2)，(8,3).<br>A                                                                       |B<br>start transaction with consistent snapshot;          |<br>                                                                         |start transaction with consistent snapshot;<br>insert(9,3)                                                          |<br>                                                                         |select 看到的仍是(7,2)，(8,3)<br>update t set c=1 where id=7                              |<br>select 看到的是(7,1)，(8,3), (9,3)                         |select 看到的仍是(7,2)，(8,3)<br>commit;                                                            |<br>                                                                        |select 看到的仍是(7,2)，(8,3)<br>                                                                        |update t set c=4 where c=3<br>                                                                        |select 看到的是(7,2)，(8,4), (9,4)<br>我的疑问是如果事务B修改了up_limit_id为事务A的transaction id，那事务B最终select应该能看到(7,1)。 <br></div> <span class="time">2019-01-20</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">可重复读隔离级别下，事务B的视图数组和高水位，执行期间都不会修改的。<br>A提交了对B的一致性视图没影响。<br></p> <p class="reply-time">2019-01-20</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Zzz</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">请教下老师，这些知识您是通过什么途径获得的呢，比如创建一致性视图的时机、方式，当前读等等。几篇文章看过来，谢谢您解决了我一直以来的不少困惑。我曾经在《高性能MySQL》、《MySQL技术内幕：InnoDB存储引擎》、《深入浅出MySQL》这些还算知名的书上翻阅过，都无法解决我的疑惑。包括MySQL官方提供的Reference Manual ，比如对于MVCC，有提过视图和undo，但是没有您讲得清晰；有提过MVCC一致性读到的数据对于update这种指令不适用（就是说可以看到别人已提交修改后的数据，外在表现在affect rows上），但是没有提到“当前读”这个概念。您是通过阅读源码知道这些知识的吗，还是有更官方的文档，而我没有接触到。</div> <span class="time">2019-01-20</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">我也是《高性能MySQL》的忠实读者哈。<br>主要是来源于我以前做云服务的时候解决用户的问题的过程中，去研究背后的原理的一些积累吧。<br><br>当前读 在官方文档中对应的是“Locking reads”，叫做加锁读也是可以的，不过平时大家说起来就是“读当前最新值”，所以叫当前读也挺理解的。</p> <p class="reply-time">2019-01-20</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/b5/33/2af9ccd1.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">panda</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">高水位不是当前事务自己吗? 当前事务启动瞬间 它的线程号应该是最大的啊<br> &quot;当前系统里面已经创建过的事务 ID 的最大值加 1 记为高水&quot;<br>为什么不是?<br><br></div> <span class="time">2019-01-18</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">事务启动时申请自己的trxid，但是创建视图列表的时候，是“稍微晚一点”的，这里有时间差，中间可能有别的事务也提交啦</p> <p class="reply-time">2019-01-18</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Geek_515b9e</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师您好，start transaction with consistent snapshot 这个命令是启动马上开启事务，那么图一中事务b是在事务a开始之前就创建了呀。为什么还可以看到c修改的数据呢，忘老师解答。。</div> <span class="time">2019-01-16</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">图1 的事务B是在事务A之后才创建的呀，<br><br>然后我没看懂你这个问题的逻辑。。你重新理一下再发一个😆</p> <p class="reply-time">2019-01-17</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e7/99/8dbfe583.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">旧时光、</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，5.7.17  REPEATABLE-READ 执行图6中事务B的update时返回死锁了。什么情况？<br>mysql&gt; update t set k=k+1 where id=1;<br>ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</div> <span class="time">2019-01-16</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这个不是死锁啊，这个是锁等待超时</p> <p class="reply-time">2019-01-16</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e5/c9/36fdec8e.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">liuq</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">怎么在别人问题下回复呢，或者引用别人的问题？<br>有个问题一直卡着：<br><br>老师您好：<br>今天重新看了一下这章您的修改地方，有个地方不明白<br>落在黄色区域未提交事务集合部分怎么还要分类，低水位+高水位不就是这个数组了吗，之前说，这个数组是记录事务启动瞬间，所有已经启动还未提交的事务ID，那不应该是未提交的事务吗，不就应该是不可读的吗<br>之前说的是启动时会获取一个最大row trx_id，所有大于这个id都不认，这个id肯定是已经提交了的事务的才对啊，这个id不才应该是数组的高水位吗，这里有点懵了<br>2018-12-03作者回复  你设计一个“比低水位大，但是在当前事务启动前，就已经提交了的例子😄<br>---------------------------------<br>无法理解，在当前事务启动前就已经提交了，不是已经不活跃了吗，怎么还在快照数组中<br></div> <span class="time">2019-01-14</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">在当前事务启动前就已经提交了，不在数组中，但是比低水位高。<br>你想下这种场景，按照时间顺序：<br>事务A启动 ，假设trx_id是1；<br>事务B启动，假设trx_id是2；<br>事务B提交；<br>事务C启动，这时候C的低水位是1，因为A还没提交。所对于C的事务数组里是没有2的，但是“2&gt;低水位（也就是1）”</p> <p class="reply-time">2019-01-14</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e9/4a/db2252f6.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">scarlett🦌</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">顿悟了，读一直是一致性读，更新是当前已提交的基础上更新。感谢作者的分享，支持</div> <span class="time">2019-01-12</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">👍</p> <p class="reply-time">2019-01-12</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e9/4a/db2252f6.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">scarlett🦌</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">例子中的事务C是在事务B后启动的，对B而言属于范围区间，按照文中的结论，在可重复读隔离级别下，B不应该可见C的执行结果，B为什么选出来是3<br></div> <span class="time">2019-01-12</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">因为B又修改了这个数据一次<br>等于最新的数据结果是B自己修改的，它就要可见</p> <p class="reply-time">2019-01-12</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/b0/37/d654fbac.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">几近虚年</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">昨天看了2遍始终不是很明白，今天早上来看，很多知识点就感觉明白了。<br>一致性视图、行锁、当前读，基本连通起来了，老师的课文讲的真好。<br>以前只会写sql语句，什么增删查改，自从决定好好学习下原理，看了老师的文章，很多东西都明白了。对以后写代码也有很多帮助，代码的顺序，sql语句的优化等。<br>多谢老师！</div> <span class="time">2019-01-10</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">👍一起学习</p> <p class="reply-time">2019-01-10</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/a1/e6/c0577a54.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">目人可分😁</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">这些天才开始撸您的文章，看完这篇文章之后，一开始我是很懵的状态，各种碎片化的知识在大脑中一直萦绕，似乎看到了光明但是又很灰暗，之后我下班之后一直在想，在关联所有学知识，经历了挺痛苦的理解和推翻 在重新理解的过程，现在我感觉有种挣脱束缚的自由感，谢谢您老师！</div> <span class="time">2019-01-10</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">哈哈👍🏿这个状态很好</p> <p class="reply-time">2019-01-10</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/12/da/a3ea305f.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">jiaobuchongจุ๊บ</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">1、start transaction with consistent snapshot; 执行完，就已经创建了 read view，read view 包括两部分 up_limit_id 和 事务活跃数组。事务小于  up_limit_id 的事务是可见的，活跃事务数组中已经提交的是可见的，本身事务做的 dml 是可见的。<br>2、如果是 begin 创建的事务，read view 会在第一次执行 select 的时候创建 read view。<br>3、更新是当前读。 </div> <span class="time">2019-01-09</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">对的 </p> <p class="reply-time">2019-01-10</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/a5/75/f23d2dd2.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">byronwx</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">感觉评论区很多人把 up_limit_id 的概念搞错了。<br>原文“当前系统里面已经创建过的事务 ID 的最大值加 1 记为高水位”</div> <span class="time">2019-01-08</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这篇文章上线以后重写过，之前用up_limit_id的概念，但是那个判断标准有点复杂，重写的版本去掉了这个概念，之前大家理解不准确只要是我的锅😄</p> <p class="reply-time">2019-01-08</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLv9HJIW4OACkjlwOQJ9cU7HzvaDFYkACWCib2lzOMef9ZiaGDTVFqjPicpVK5KDRbBRVGGHrMHQO1Rw/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">fdconan</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">请教下，文章说：当然，如果“上一个版本”也不可见，那就得继续往前找。这个不太好理解。</div> <span class="time">2019-01-07</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">啊？就是说得一直往一直往前直到最后找到自己可见的版本</p> <p class="reply-time">2019-01-08</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/6b/c6/2534e14a.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">spraith</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">“如果落在黄色部分，那就包括两种情况<br>a. 若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见；<br>b. 若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见。”<br>这里的b，怎么会不在“活跃”数组中的？黄色是在高低水位之间，这之间的事务id都记在活跃数组中，所以按理来说应该不可能出现b情况啊，想不明白，求解答</div> <span class="time">2019-01-07</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">其它同学的评论中有答复了😄</p> <p class="reply-time">2019-01-07</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e5/39/951f89c8.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">信信</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师您好，文章中提到：<br>如果把事务 A 的查询语句 select * from t where id=1 修改一下，加上 lock in share mode 或 for update，也都可以读到版本号是 101 的数据，返回的 k 的值是 3。我认为这里会因为事务B未提交而被阻塞。请老师指正。此外，还有个问题：什么情况下高水位会大于自己的事务id？文中举例的几个事务id也都是等于视图数组的高水位的。</div> <span class="time">2019-01-07</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">1. 你说的对，我文中意思是事务B提交后返回版本号是101的数据；<br>2. 事务创建后，在获取视图数组前，有可能出现别的事务启动</p> <p class="reply-time">2019-01-07</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/de/23/be735002.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">山人</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师你好！<br>针对图3，“数据版本可见性规则”的几种可能性解释的3(b)有疑惑：若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见。<br>既然落在黄色部分，就是未提交的事务。怎么后面说是已经提交了的事务生成的呢？如果理解为：当前事务自己生成的，是不是更合理些。</div> <span class="time">2019-01-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">不一定是自己的，可能是“比低水位后启动的、但是已经提交了的事务”</p> <p class="reply-time">2019-01-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/c6/51/4f0e0577.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">劉阳河</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，C查询一行数据， A和B都对这行数据进行了提交，这种情况下也是根据transid和事物启动时的数组来看A和B对于C都是可见的，但是A的transid小于B，A也晚于B提交，那是怎么保证C看到的是 A提交的数据？</div> <span class="time">2019-01-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">A晚于B提，说明最新的版本是A生成的对吧<br><br>然后C去读数据的时候，就从最新版本开始读，先读到A生成这个，由于对C可见，就直接读走了</p> <p class="reply-time">2019-01-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/c6/51/4f0e0577.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">劉阳河</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，我现在理解是  当A对一行进行操作时，开启事务，创建transid，然后B再对这一行操作时，必须要等到A提交释放锁后啊才可以继续操作，所以说明transid是严格递增的，查询一行数据时只查找transid最大的数据就可以了</div> <span class="time">2019-01-02</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">不是，你想这个序列：<br>A启动，更新id=1, <br>     B 启动更新id=2，提交； <br>A更新id=2，再提交；<br></p> <p class="reply-time">2019-01-02</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/1b/17/64e18a78.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">雪候鸟</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">我想问问读未提交隔离级别是怎么实现的</div> <span class="time">2019-01-02</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">就是直接读最新版本，连有没有提交都不管</p> <p class="reply-time">2019-01-02</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/c6/51/4f0e0577.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">劉阳河</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，有三个事务，事务A先启动tranid是100，事务B再启动tranid是101，都对id=1的行操作，B先操作然后提交，A再操作然后提交，此时C开启事务执行查询id=1的行，那它应该拿的是tranid为101的数据，这样不就读不到最新的了吗</div> <span class="time">2019-01-02</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">不是啊，此时C拿到的是A操作后的结果哦。</p> <p class="reply-time">2019-01-02</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/a4/31/e48393bf.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Manjusaka</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">问题应该就是 MySQL RR 下的幻读吧<br>官府在我理解看来也是一种不可重读，不过作用的范围也不一样<br>目前看起来比较好的解决方案就是 CAS ，最暴力的就是串行化<br>复现的话，记得提交事务，不然在老师的 SQL 会被锁住</div> <span class="time">2019-01-02</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/01/c4/9a0c9535.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">窗外</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">在可重复读隔离级别下，事务在启动的时候就“拍了个快照”。注意，这个快照是基于整库的。<br><br>有个疑问啊，对于库中的 myisam 表是怎么处理的？<br><br>作者回复<br>MyISAM 不支持事务…<br><br>就是考虑到 myisam 不支持事务，所以才想知道，做快照时对 myisam 表是怎么处理的，因为您不是说基于整库的嘛，整库肯定包括各种引擎的表啊</div> <span class="time">2019-01-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">我说的整库是专指“整库中的所有Innodb”哈，嗯嗯忘记强调了<br><br>MyISAM 表没处理，所以每次要读数据的时候都去直接读最新的，没有可重复读这个特性</p> <p class="reply-time">2019-01-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/01/c4/9a0c9535.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">窗外</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">在可重复读隔离级别下，事务在启动的时候就“拍了个快照”。注意，这个快照是基于整库的。<br><br>有个疑问啊，对于库中的 myisam 表是怎么处理的？</div> <span class="time">2019-01-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">MyISAM 不支持事务… </p> <p class="reply-time">2019-01-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">myf</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">数据库是设置auto conmmit的，而且这种问题不是必然出现，是偶尔出现<br>--------------------------------<br>笔误，是相差几十毫秒，是业务日志显示已经插入成功，返回了影响行数1，然后启动的查询没查到，有点奇怪<br>--------------------------------<br> 作者回复<br>是不是在事务中没提交？</div> <span class="time">2018-12-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">额…这样描述比较难这么回答了😓</p> <p class="reply-time">2018-12-31</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/6b/c6/2534e14a.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">spraith</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">我想到一种更容易理解的方法来说明innodb的mvcc。如下：<br>我们可以在现实中找到同样的问题，然后对现实问题进行解决。<br>我想到的是这样的，假设有六个人（对应于六个事务，人员编号对应于事务id）一起修改及阅读一本书（可对应整个数据库），并且有如下规则：1.同一页书同一个时刻只能允许一个人修改（页对应于一行记录，这条规则对应于行锁）2.某个人翻开书的瞬间（对应于事务开始），在他把书放下之前，不管这期间有多少人在改这本书，他看到的内容是不变的（对应于可重复读）。<br>再假设六人改书的顺序：除了3号，其他人都是改了某些页的内容，并且按编号依次顺序修改，而3号则是第三个参与进来的人，他只看书，看书的时间一直持续到了第6号人把书改完。<br>上面这种假设是符合常理的，因为现实中确实可能出现这样的场景（当然现实中不一定是改书了）。好了，现实问题已经构建完成，接下来我们就思考一下如何帮3号更高效地实现规则2。<br>首先最容易想到的是3号拿到的是他参与瞬间的整本书的复印件，这样是不会被其他人修改打扰了，但是复印整本书，效率只能是“呵呵”了。<br>继续想改进的办法。3号想，我进来的时候，2号已经改完了，所以我直接看他的版本就行（即不用管id比自己小的事务），但是456号的改动是在我未看完期间，他们的改动量相对于整个书是很小的，我能否让他们把各自的改动都记下来，分别记为d4，d5，d6（d是delta，增量的意思），dn的内容只需要记录哪个人（事务）改了哪页内容（哪条记录），并且要记录某页书最后一次是被谁改动的。<br>这样，当3号读到当前的某页书记录着被6号改动了，那只需要把当前页的内容-d6-d5-d4 就可以得到3号刚进来时的同一页书的内容了，如果看到某页被2号改动，直接读，如果看到被4号改动，则回退一下d4即可。<br>这种方案明显比复印整个书的方案要节省空间和时间。<br>现在回到数据库的mvcc，来把一些还未对应进去的数据库术语对进去：d4这些增量，本质上和数据库的undo log是一样的；低水位则对应于4号，高水位在这个例子中，至少是比6号更大的事务id（高低水位的边界有点记不太清楚，可能会有1的差异，主要能理解意思就行）；undolog的清除时机也很明显了，就是要能保证可以还原到3号的那个版本，d4（不包含d4）以前的都删除。</div> <span class="time">2018-12-30</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/5b/94/091258c2.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">林千景</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">图4事务A读数据的时候，此时最大事务ID是102，read-view是[99，100，10]，所以低水位是99，高水位是103。当前数据版本是(1,3),事务ID是103，文中说【找到 (1,3) 的时候，判断出 row trx_id=102，比高水位大，处于红色区域，不可见】;可是102不是比103小么？</div> <span class="time">2018-12-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">在可重复读的时候，高水位这个指是事务创建的时候，保存起来的。<br><br>虽然后来变成103，但是sessionA 的事务数组和高水位都没有改变，所以判断的时候102是大于它的高水位的</p> <p class="reply-time">2018-12-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">myf</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">笔误，是相差几十毫秒，是业务日志显示已经插入成功，返回了影响行数1，然后启动的查询没查到，有点奇怪<br>-----------------------------------------------------------------------<br>请教一下，我在mysql实践中遇到个问题，就是同一个后台服务的方法A中执行了插入一条数据成功后，然后方法B中去查询发现没查到这条数据，其中方法B是一个异步方法（另一线程），看日志发现查询是在插入后几十微妙，这是不是出现幻读了，有什么办法解决吗？隔离级别是Repeatedable Read，数据库没有读写分离，查询条件也是唯一索引的。<br>2018-12-28<br> 作者回复<br>这个不是幻读呀，这个是写入了查不到<br><br>你看的“查询在插入之后几十微秒发起”，这个日志是客户端日志，还是数据库日志？<br>数据库除非特别定制，否则没有微秒单位，<br>如果是业务发送端的话，有可能查询是后发先到哦，毕竟才差几十微秒…<br></div> <span class="time">2018-12-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是不是在事务中没提交？</p> <p class="reply-time">2018-12-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/5b/94/091258c2.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">林千景</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">高水位是103，row trx_id=101为什么会比高水位大？</div> <span class="time">2018-12-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是指那一个图？ 具体指明图几哈</p> <p class="reply-time">2018-12-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">myf</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">请教一下，我在mysql实践中遇到个问题，就是同一个后台服务的方法A中执行了插入一条数据成功后，然后方法B中去查询发现没查到这条数据，其中方法B是一个异步方法（另一线程），看日志发现查询是在插入后几十微妙，这是不是出现幻读了，有什么办法解决吗？隔离级别是Repeatedable Read，数据库没有读写分离，查询条件也是唯一索引的。</div> <span class="time">2018-12-28</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这个不是幻读呀，这个是写入了查不到<br><br>你看的“查询在插入之后几十微秒发起”，这个日志是客户端日志，还是数据库日志？<br>数据库除非特别定制，否则没有微秒单位，<br>如果是业务发送端的话，有可能查询是后发先到哦，毕竟才差几十微秒…</p> <p class="reply-time">2018-12-28</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/d4/96/b257de7f.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">灰机。</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，您好我有个问题，事务在创建快照的时候，数据版本是否可见是由数据版本小于等于当前事务id决定，这个地方有点不解，比如同时并发五个事务，事务id分别为98,99,100,101,102，假如在事务98创建活跃数组的时候101已经提交，那么事务98的活跃数组就为98,99,100,102，此时事务101对98是可见的，这和数据版本小于等于当前事务id可见有点矛盾，我觉得应该是按活跃数组来确定，第一种只是大致上的，对么，老师</div> <span class="time">2018-12-27</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">额，事务id递增的，怎会98创建的时候，101提交了😓</p> <p class="reply-time">2018-12-28</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/6f/06/82d8bdfb.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">D.L</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">您好，请问tcc下是怎么实现分支事务能够看到其他分支事务修改的内容的？gts可以吗？</div> <span class="time">2018-12-27</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/12/93/3470fc43.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Mr.钧👻</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，我有个疑问，数据版本可见性规则图中，落在黄色部分，为什么会有a b两种情况呢？既然数组包含的，都是启动未提交的事务，应该都不可见才对吧？</div> <span class="time">2018-12-27</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">也包含提交了的</p> <p class="reply-time">2018-12-27</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/2b/bb/5cf70df8.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">嘉嘉☕</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师还有一个问题<br>对于当前事物启动瞬时来说，高水位就是它自己的id+1吧？</div> <span class="time">2018-12-26</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">但是创建数组得时候，已经比“启动瞬间”稍晚一会儿了</p> <p class="reply-time">2018-12-27</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/2b/bb/5cf70df8.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">嘉嘉☕</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师, 请问一下,<br>------------------------<br>但是，当它要去更新数据的时候，就不能再在历史版本上更新了，否则事务 C 的更新就丢失了。<br>因此，事务 B 此时的 set k=k+1是在（1,2）的基础上进行的操作。<br>------------------------<br>这个地方我比较疑惑, <br>为什么不能让C的更新丢失呢 ?<br>C来得早, 而且已经提交了, 被后面的更新所覆盖不是很正常吗 ?<br>没太想明白这块, 希望老师能给解惑<br>谢谢</div> <span class="time">2018-12-26</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">就是说，这时候应该按照3+1=4来算才对，对吧<br><br><br>但是如果还当作2，算成2+1=3，前面等更新结果就等于没做了，这个丢失是不能接受的</p> <p class="reply-time">2018-12-26</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/EfYxc1HovSS5fMHKyhSiaG00H2CG5Z9XU6ibV9aBiagWFH4Co53icq2uCFZs3ksHEz9OHK6SxCUicwVdwyrhgRLiaR8A/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Geek_fe79fa</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师好，事务里的一致性读，不受其他事务锁（update操作的行锁、select读锁、排他锁）的阻塞影响，其读取结果受事务隔离的影响。不知这样理解正确不？</div> <span class="time">2018-12-26</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/bd/da/abb7bfe3.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">进击的菜鸡</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">这章读完瞬间觉的茅塞顿开，希望在老师的带领下对MySQL的理解能有一个质的提升(∩_∩)。但是又有一个疑问。就是如果说根据一致性视图读取可见数据，那么RR级别下为什么不能阻止幻读呢。例如RR级别下，session A先执行select范围查找开启一致性视图(使用begin开启事物)，此时session B在A之后开启事物恰好insert了一条符合A范围查找的数据并立刻commit，然后A又执行了同样的语句。如果按照一致性视图B插入的数据RTX_ID大于A的事物ID那么A就不会读取到B插入的数据。这样的话岂不就可以防止幻读了？那么为什么MVCC不能有效防止幻读？百度了一下，甚至有人说就是因为MVCC才引入了幻读。还请老师解惑一下。</div> <span class="time">2018-12-25</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">你理解的对，快照读是不会有幻读的。<br>但是这时候如果select是用lock in share mode ，就会看到新插入的数据了。<br><br>第20篇专门讲幻读哈😄</p> <p class="reply-time">2018-12-26</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/9b/22/dd04892a.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">heat nan</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，你说的落在红色区域的是由将来启动的事务  是否不准确？是否应该是比当前事务id大的且没提交的</div> <span class="time">2018-12-24</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这两个比起来，还是“将来启动”更准确些😄</p> <p class="reply-time">2018-12-24</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/45/91/afda3094.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">是我的海</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">这篇文章真的是全程高能，看了快一下午，从头开始仔细梳理了下，仿佛明白了很多东西。<br>有个问题想请教老师，就是MDL 锁跟 我在其他地方看到的意向锁是一回事么 ？ </div> <span class="time">2018-12-23</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/61/c7/b64ac05e.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">sky</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师2个问题<br>1:trx_id 始终自增，不会超长么，是用什么类型存储的，db大量开启事物跑了一年这个trx_id得多大<br>2: 如果落在黄色部分，那就包括两种情况<br>a. 若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见；<br>b. 若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见。<br><br>既然是落在黄色区域，不就都是当前事务开启时活跃的trx-id 么，为啥会不在数组内</div> <span class="time">2018-12-22</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/2f/22/ed2b9b35.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">a劳</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">好呀！有个问题没太明白.<br>哪个事务C&#39;的，和事务B修改同一条数据，为啥事务C&#39;都没提交，事务B也能修改？不是应该有行锁的x锁吗？</div> <span class="time">2018-12-19</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">没有提交呀，堵住了……<br>要等C’提交了才B才能继续的</p> <p class="reply-time">2018-12-20</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/ed/d2/e3ae7ddd.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">三木禾</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">row trx_id 当前事务以前的事务提交的数据==》绿色部分 本事务是可见的<br>row trx_id 当前事务以后的事务提交的数据==》红色色部分 本事务是不可见的<br>row trx_id 在数组中，由其它事务提交的，那肯定是不可见的，因为隔离级别为3。<br>row trx_id 不在数组中，怎么会出现不在数组中的情况呢，是不是高水位？</div> <span class="time">2018-12-19</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">低于高水位，但是提交了</p> <p class="reply-time">2018-12-19</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">xinzhong</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">&quot;所以，如果把事务 B 的查询语句 select * from t where id=1 修改一下...&quot;,这里是不是应该是事务A，B无论加不加锁都应该读到3，因为3是他更新的</div> <span class="time">2018-12-19</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">啊，你说的对，👍🏿细致<br><br>我勘误一下</p> <p class="reply-time">2018-12-21</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">xinzhong</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">对于置顶留言夏日雨自己的理解，既然98事务没有提交，那么事务A的列表不就变成了[98,99,100]了吗，按照作者文中讲的不会出现你说的那种情况吧？所以事务A的up_limit_id应该是98，而不是99了吧？不知道是不是这样</div> <span class="time">2018-12-19</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/ed/d2/e3ae7ddd.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">三木禾</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">里面有个视图数组，不是当前活跃的事务ID组成的数组么</div> <span class="time">2018-12-19</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">就是当前活跃事务ID数组呀</p> <p class="reply-time">2018-12-21</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/de/e1/de266478.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">就是个渣渣</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">林老师，图五那里：更新数据都是先读后写的，而这个读，只能读当前的值，称为“当...“<br>这里更新同一行数据不是会有锁么？？？</div> <span class="time">2018-12-18</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">会呀，但是如果别的事务提交了，就就没有锁等待了</p> <p class="reply-time">2018-12-19</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/ec/cb/27033e11.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">王木鱼</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">文中的这个语句：<br>“是的，如果事务 B 在更新之前查询一次数据，这个查询返回的 ...”<br>是不是应该改为<br>“是的，如果事务 B 在更新之前查询一次数据(加锁查询)，这个查询返回的 ...”<br>才是正确的？<br>否则这个语句就是思考题了，刚好证明思考题情况不存在。</div> <span class="time">2018-12-18</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">不是，这里要说的就是非加锁查</p> <p class="reply-time">2018-12-18</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/5c/1c/7a2e8bee.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">🐋</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">思考题：<br>事务A：<br>begin;<br>select * from t;<br>&#47;*<br>*这个时候执行了事务B<br>*&#47;<br>update t set c= c + 1 where id=c;<br>select * from t;<br><br>事务B：<br>update set c = c + 1 where id = c;<br><br>请问老师在事务A中update语句set部分c读取到事务B更新后的值，而where 部分id读取的c是事务A一致性视图中的值，由于两者不一致导致更新记录为零的对吗？<br></div> <span class="time">2018-12-17</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">不是，<br>整个update语句走的当前读，因此where读的就是事务B修改后的值啦</p> <p class="reply-time">2018-12-17</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/8a/a7/674c1864.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">William</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师启动了事务，此事并未执行任何语句，会生成trx_id么？<br><br>看了您对@算不出流源的会发，发现有<br>“都是“事务启动”的时候申请，<br><br>所以是第一个操作表的语句。<br><br>也可以是执行start transaction with consistent snapshot这个语句的时候”<br><br>我的理解是申明事务的时候不会生成。<br>然后假设有crud操作的时候，才会生成对么？</div> <span class="time">2018-12-17</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/8a/a7/674c1864.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">William</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，针对 @崔根禄 的问题，如果不仅仅从数据库层面考虑，<br>是不是也可以加一个业务锁，比如用redis，设置一个 key ： lock_kucun 如有值，则说明正在由线程在操作此任务，<br>后续的去排队，等上一个执行完了，再接着执行。然后校验是否有剩余。<br></div> <span class="time">2018-12-17</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/0FI2bUjegtznv7XPC9DB9RJaqiaMiamWkibibPOibuUC3DCvI7XMvBANr6sDjRNbc1jwPic9pIaFxrdaib88VqUJKXSTQ/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Chenl07</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，我碰到一个问题：数据库show processlist存在大量opening tabale的情况，此时数据库接近瘫痪，这个跟阻塞有关么？</div> <span class="time">2018-12-11</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">阻塞一般就提示为阻塞了，也可能根本就是并发太大…</p> <p class="reply-time">2018-12-11</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/b8/36/542c96bf.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Mr.Strive.Z.H.L</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">关于事务A，B与C‘的疑惑：<br>因为事务C是更新后马上提交，B的update属于 当前读 的情况。<br>而事务C‘是获取了行锁，所以B必须阻塞等待C&#39;提交后，再进行 当前读。<br>我的疑惑在于，行锁一般都是sql语句指定的，而不是innodb自动加的，如果在事务C&#39;update语句中，我没有获取行锁，那么事务B在update的时候获取到的值肯定不是2，而是1，最后结果也是2。这种情况就是因为没有加行锁，而发生了并发问题。<br>老师您看我这么理解是正确吗？？</div> <span class="time">2018-12-11</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">描述反了哦：行锁一般不是SQL语句指定的，在innodb自动加的😄</p> <p class="reply-time">2018-12-11</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/fd/66/8db1f464.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">雯子Arωeฅ</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，有个问题，为什么我把autocommit设置为0。 然后按照start transaction 启动事物，但是为啥不能启动多个事物</div> <span class="time">2018-12-10</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e3/2e/77ad18f4.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">滔滔</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师您好，像update t set k=1 where id=1这条更新语句是不是不需要先获得当前读的值，因此不需要先获得读锁而是直接获得排它锁然后更新值？</div> <span class="time">2018-12-10</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/04/fb/40f298bb.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">小罗希冀</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">刚刚重看了一下这一篇文章，发现里面内容的描述改了很多，但是我还是认为之前的讲得比较清楚，现在新版的都把up_limit_id的介绍删除了</div> <span class="time">2018-12-09</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">额，是这样的，原来的太公式化了，平时我们在判断的时候，用起来麻烦</p> <p class="reply-time">2018-12-09</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/13/56/6a062937.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">gentleman♥️</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">这个 update语句和row rxid生成的时候 说明数据已经写入数据页了吧？那个unlog就是方便来回滚的对吗？</div> <span class="time">2018-12-09</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">对</p> <p class="reply-time">2018-12-09</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/53bf91d3.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">WL</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师真的很负责, 这周的内容比上周看讲得更细致了</div> <span class="time">2018-12-08</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/30/29/7d34099d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">ithunter</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，我提的问题：A、B相互喜欢的问题，我觉得是不是另外建一个用户喜欢操作表user_like_op，字段为 包含user_id，并为唯一索引。在A喜欢B时，加 X锁，select * from user_like_op where user_id = A for update，select * from user_like_op where user_id = B for update，把流程做到事务里。不知道您的解法是什么？</div> <span class="time">2018-12-07</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">为了让互相喜欢都操作同一行，你可以多一个字段，表示关系。比如等于1 是A喜欢B， 等于2 B喜欢2 ，等于三互相喜欢。<br>展开比较复杂，我放到答疑篇了</p> <p class="reply-time">2018-12-07</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/8b/ee/49ba9142.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">王虹凯</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">不能层级的回复留言，好尴尬，有些针对留言的讨论不能进行。<br>针对前面有个建立好友关系的，我觉得就查询是否有记录和插入表可以从其他业务中剥离（其他不必需要的），让整个事务尽可能小，而且这个查询判断可以走RC,尽量减少RR对乐观锁带来的不命中。另外，这种场景，我觉得可以异步去做，配合一个内存级别的bitmap 操作判断是否被喜欢以及好友关系bitmap,减少通过db判断。<br><br>针对问题-创建数组和最大上限的过程中，新事务ID：假如没有锁，那新创建的事务，也肯定会比最大的事务ID大，就算不在数组，在边界判断就不满足条件了。<br><br>欢迎讨论！<br></div> <span class="time">2018-12-07</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">对于可见性和视图数组这个理解很好</p> <p class="reply-time">2018-12-07</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/05/d4/e06bf86d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">长杰</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">现在事务 A 要来读数据了，它的视图数组是 [99,100]。当然了，读数据都是从当前版本读起的。所以，事务 A 查询语句的读数据流程是这样的：<br><br>找到 (1,3) 的时候，判断出 row trx_id=101，比高水位大，处于红色区域，不可见。<br>有个疑问，<br>为何会比高水位大？事物A当前事物数组99和100,高水位是当前系统中最大的事物id加1,高水位至少是101,应该是大于等于高水位就是处于红色区域吧？</div> <span class="time">2018-12-06</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是，其实是大于等于都算</p> <p class="reply-time">2018-12-06</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJAibnPX9jW8kqLcIfibjic8GbkQkEUYyFKJkc39hZhibVlNrqwTjdLozkqibI2IwACd5YzofYickNxFnZg/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Sinyo</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">第二个有效更新是事务 B，把数据从 (1,2) 改成了 (1,3)。这时候，这个数据的最新版本（即 row trx_id）是 101，而 102 又成为了历史版本。<br><br>老师，请问这里可不可以理解成事务B用102替代了原来的101，最新的还是102呢？<br></div> <span class="time">2018-12-06</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">不能，最新的就是101，图中画的那样</p> <p class="reply-time">2018-12-06</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/4a/45/04a13bf9.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">bing</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">&#47;&#47; 判断数据对应的聚簇索引中的事务id在这个readview中是否可见<br>bool changes_visible<br>(<br>        <br>trx_id_t<br>        id<br>,<br> <br>&#47;&#47; 记录的id<br>    <br>const<br> <br>table_name_t<br>&amp;<br> name<br>)<br> <br>const<br>MY_ATTRIBUTE<br>((<br>warn_unused_result<br>))<br>{<br>    ut_ad<br>(<br>id <br>&gt;<br> <br>0<br>);<br>    <br>&#47;&#47; 如果当前记录id &lt; 事务链表的最小值或者等于创建该readview的id就是它自己,那么是可见的<br>    <br>if<br> <br>(<br>id <br>&lt;<br> m_up_limit_id <br>||<br> id <br>==<br> m_creator_trx_id<br>)<br> <br>{<br>        <br>return<br>(<br>true<br>);<br>    <br>}<br>    check_trx_id_sanity<br>(<br>id<br>,<br> name<br>);<br>    <br>&#47;&#47; 如果该记录的事务id大于事务链表中的最大值,那么不可见<br>    <br>if<br> <br>(<br>id <br>&gt;=<br> m_low_limit_id<br>)<br> <br>{<br>        <br>return<br>(<br>false<br>);<br>        <br>&#47;&#47; 如果事务链表是空的,那也是可见的<br>    <br>}<br> <br>else<br> <br>if<br> <br>(<br>m_ids<br>.<br>empty<br>())<br> <br>{<br>        <br>return<br>(<br>true<br>);<br>    <br>}<br>    <br>const<br> <br>ids_t<br>::<br>value_type<br>*<br>    p <br>=<br> m_ids<br>.<br>data<br>();<br>    <br>&#47;&#47;判断是否在ReadView中，如果在说明在创建ReadView时 此条记录还处于活跃状态则不应该查询到，否则说明创建ReadView是此条记录已经是不活跃状态则可以查询到<br>    <br>return<br>(!<br>std<br>::<br>binary_search<br>(<br>p<br>,<br> p <br>+<br> m_ids<br>.<br>size<br>(),<br> id<br>));<br>}<br><br>读源码证明</div> <span class="time">2018-12-06</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/4a/45/04a13bf9.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">bing</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">当检索到的数据的事务ID表示的是当前事务自己修改的数据(数据行的DBTRXID = mcreatortrx_id) 时，数据可见。<br><br>所有上面讲的有点问题</div> <span class="time">2018-12-06</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/1c/39/aafcb4e2.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Lei</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">置顶留言中”现在正在执行的所有事物ID列表” 和文章中的<br>”用来保存这个事务启动瞬间，当前正在“活跃”的所有事务 ID。“活跃”指的就是，启动了但还没提交”<br>不是一个意思吗？  正在执行，不就是以启动未提交吗？</div> <span class="time">2018-12-06</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">歪歪鱼</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">因此，一个事务只需要在启动的时候声明说，“以我启动的时刻为准，如果一个数据版本是在我启动之前生成的，就认；如果是我启动以后才生成的，我就不认，我必须要找到它的上一个版本”。<br><br>老师，这里的这句话 “如果一个数据版本是在我启动之前生成的，就认” 有个前提条件得是提交了的事务吧？ </div> <span class="time">2018-12-06</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是的，提交的</p> <p class="reply-time">2018-12-06</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">李</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">如果落在黄色部分，那就包括两种情况<br>a. 若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见；<br>b. 若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见<br><br><br><br>我的问题是，落在黄色部分的还是都是事务启动时活跃的其他事务，那么应该都会落在数组里面，为什么还有不在数组的情况呢？</div> <span class="time">2018-12-06</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">已经提交了的<br></p> <p class="reply-time">2018-12-06</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/1d/7f/aabc1b66.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">hetiu</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，请教个问题，RR事务read view开始时间应该是在第一条CRUD语句，而不是BEGIN或START吧？也就是说，A事务SELECT时，所有已经commit的结果都是可以看到的。</div> <span class="time">2018-12-06</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">说的哪个图…</p> <p class="reply-time">2018-12-06</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/05/d4/e06bf86d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">长杰</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">在读提交隔离级别下，事物数组是如何维护的？活跃的事物处于黄色区域，如果某个黄色区域的事物提交了，数据就是可见的，事物是否从数组中移出？</div> <span class="time">2018-12-05</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是的，事务提交了，就不属于活跃，再创建视图数组，数组里就没它了</p> <p class="reply-time">2018-12-05</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/f7/69/d8dba3de.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">DanielAnton</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">文中这里“事务 B 是当前读，必须要读最新版本，而且必须加锁，因此，就被锁住了，必须等到事务 C&#39; 释放这个锁，才能继续它的当前读。”我的理解是，行锁不是唯一的吗，事务 B 此时应该是被阻塞了吧，只有等到 C’释放锁，它才能竞争获取当前锁吧。请老师指教。</div> <span class="time">2018-12-05</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">嗯，这段说的是过程，你说的是结果，咱俩没矛盾哈</p> <p class="reply-time">2018-12-05</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/f7/69/d8dba3de.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">DanielAnton</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">问个问题，事务 A 的视图数组是 [99,100]，那么低水位是 99 ，高水位是 101？</div> <span class="time">2018-12-05</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是的</p> <p class="reply-time">2018-12-05</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/05/d4/e06bf86d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">长杰</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师好，您在文章中说begin不是事物的起点，第一个执行的innodb表操作的时候，事物才开始，那么申请事物id也是在第一个操作inodb表的时候申请的吗？</div> <span class="time">2018-12-05</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是，事务是在事务启动时候生成的</p> <p class="reply-time">2018-12-05</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/62/81/ad80f427.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Lane</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">重写以后果然就看懂了...之前真的没看懂，有点晦涩</div> <span class="time">2018-12-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">变量要少，“讲清楚”这个能力，我也在学习中😄</p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoH6lQA2ib1sV9hdJF7gnfFegC8egDPssYFDpJYUU6ZpAtTMZLdU3ApLYJZkxnKBrXibGUYxUabUnkg/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">sayhelen</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">留个笔记，update inster等语句执行时也是一个事务，会执行 commit</div> <span class="time">2018-12-04</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIrunVjKyFdya4mu8XXbqWepfiakljMV8gvevUFbh7bempdWdrwia5M2fdQh51K50PxlOKJVibGH7lTg/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">城市之光</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，3(b)“若 row trx_id 不在数组中”，对于事务启动当前瞬间正活跃的事务组成的数组，row trx_id 能落在未提交事务中，而又不这个数级中，什么情形下会出现这样的记录呢？</div> <span class="time">2018-12-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">不在这个数组中，表示提交了。<br>因为视图数组只记录那些“当前活跃事务ID”</p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/34/1f/ef171ece.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">阿洛飛</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">标准答案的话个人觉得有些超过了已有的知识点的范围，CAS啊，乐观锁和悲观锁等等这些概念在没有提示的情况下实在想不出来，或许老师给些提示会更好<br><br>不知道从已有知识的角度去理解的对还是不对：<br>在RR事务隔离情况下，SessionA和SessionB的事务是隔离的，也就是说SessionA的视图列表中并看不到SessionB的更新，当SessionB更新了之后SessionA要更新id=c的row，因为更新语句是需要读当前值的，所以这里SessionA的更新语句看到的当前值中id和c都是不想等的，所以更新无效<br><br>又由于是RR事务的隔离，所以SessionA更新后Select出来的内容依然是SessinA视图中的可见的内容<br><br>不知道这么理解是否正确，还请老师指正</div> <span class="time">2018-12-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">最后一段，需要指出“由于更新没有成功”，这几行数据的row trx_id 没变，所以再查还是查不出来</p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/59/80/dc4a799f.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">supertizzy</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">@约书亚 的评论。个人觉得在mysql innodb引擎中，增加version字段实现乐观锁的方式在实际应用场景中有点多此一举的味道。在对某一行进行cas更改的时候，针对该行记录innodb会加行锁（排他锁），update ...set ... where id = xxx and version = xxx，其他的线程依旧是阻塞的，并没有起到一个“无锁”的效果。那么我是不是可以理解为这种设计是针对没有行锁的情况下？</div> <span class="time">2018-12-04</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Geek_a9a978</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">事务的 id 是在事务&quot;开始&quot;还是事务&quot;启动&quot;时分配的呢？<br>按道理应该是事务&quot;开始&quot;的时候，但如果这样，文中黄色&quot;未提交的事务集合&quot;是否还应当包括&quot;已开始&quot;但&quot;未启动&quot;的事务？如果包括的话，而数组又是所有&quot;已启动但未提交&quot;的事务，第三条中是否不在数组中的还应当包括这种&quot;已开始&quot;但&quot;未启动&quot;的事务？那这种也应当是不可见的？</div> <span class="time">2018-12-04</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e1/09/9483f537.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">☞</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师能麻烦举一个即在黄色区域，又可读的例子吗，我还是认为黄色区域的肯定是我事务启动时，其他事务还未提交的，这部分数据我感觉在RR下怎样都是不可读的才对</div> <span class="time">2018-12-04</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/45/ae/a213a2a3.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">tinsang</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">事务在启动时,找到已提交的最大事务ID记为up_limit_id，按照文中所提的，B的是101，C是102，B最后提交更新，那最大的事务ID不就是102吗？可是最新更新的是101呢？</div> <span class="time">2018-12-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">换用低水位来理解哈</p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e1/09/9483f537.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">☞</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">b. 若 row trx_id 不在数组中，表示这个版本已经提交事务产生的，是可读的<br>老师我还是不太懂这个啊，落在黄色区域，我可以理解为是还没提交的事务ID啊，您这边之前说<br>innodb为每个事务构造了一个数组，用来保存这个事务启动瞬间，所有已经启动但是还未提交的事物ID <br>那怎么可能又落在黄色区域，row trx_id又不在数组中呢<br></div> <span class="time">2018-12-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">黄色区域是“高水位和低水位之间的事务ID”<br><br>这个数组不保证是“连续自然数”的</p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">有铭</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">新改过的文章里，还是存在问题<br>如果transaction id是严格递增并唯一，按文章的解释，mysql如何知道哪个是最新版本的呢？我开始以为mysql的机制是取最大transaction id来作为最新版本，但是文章上说transaction id 101可以取代transaction id 102变成最新版本，如果说，小transaction id能作为最新版本，MySQL如何识别哪个transaction id是数据的最新版本？</div> <span class="time">2018-12-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这个可以理解为一个链表，最新版本是链表的入口哦</p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/fa/61/691e2936.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">算不出流源</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">疑问一：图3是否有误？当前事务的txid必定等于高水位吧？因为“在实现上， InnoDB 为每个事务构造了一个数组，用来保存这个事务启动瞬间，当前正在“活跃”的所有事务 ID。”说明在事务启动瞬间它的txid必定是系统里最高的水位。<br><br>疑问二：事务启动的时候为什么InnoDB要为事务构造一个“数组”，不是保存高低水位就可以了吗？</div> <span class="time">2018-12-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">1. 有可能高水位会略大一点<br><br>2. 高低之间要有一些已经提交过的</p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLhRH6fwgzxMicpEvKzSOmmicwibTCxqVXR65ibnFKWicDlWqVe1LR8FZRz5Yh9tFibiawSMBbNEBmD7ibkgA/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">菜鸟萌新</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，请问一个问题，低水位和up_limit_id不是相等的吧，高水位我理解是当前事物</div> <span class="time">2018-12-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">高水位可能比当前事务大，因为创建事务后，到创建事务视图之间的执行代码期间，可能有新事务创建出来。<br><br>忽略up_limit_id 吧😄</p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/21/57/ee02ef41.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">大龄小学生</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师是不是没提交的事务查询不到。</div> <span class="time">2018-12-04</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">除非你设置了隔离级别为“读未提交”</p> <p class="reply-time">2018-12-04</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/4f/78/c3d8ecb0.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">undifined</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师有一个问题，文章开始说 change buffer 不适用于写完之后立刻读取的场景，我的理解是 记录 change buffer 之后，如果要读就得先purge，将数据保存在硬盘上，然后再读取到内存中；但是文章末尾说 需要把 Page2 从磁盘读入内存中，然后应用 change buffer 里面的操作日志，生成一个正确的版本并返回结果；那么这个过程是在内存中做的，这个过程相比数据没有在内存中的普通查询多了一次 purge 的过程而已，所以这种查询消耗最多是&quot;随机访问的 IO 的次数不会减少，反而增加了 change buffer 的维护代价&quot;是吗？想和老师确认一下 purge 的过程需要先把数据读到内存然后更新之后放回到硬盘还是直接更新硬盘的数据？purge 发生在哪儿</div> <span class="time">2018-12-03</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/09/c7/861b4a70.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">泰格杨</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">文稿是不是有缺失？落在黄色部分的2种情况是啥？</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">额，还在呀。<br><br>a. 若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见；<br>b. 若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见。</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/ef/59/3e454a59.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">dpqb</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">请问下老师，您说的那个正在执行的事务的id列表怎么理解呢?和活跃的事务ID数组有什么区别呢?因为我理解的活跃的事务不就是正在执行的事务吗?还是等待的事务不算是正在执行?</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">这俩是同一个概念的</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/94/59/ac2aa72b.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Smile</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，您好，有两个问题还麻烦抽空解答一下：<br>问题1:<br>上个版本中为：事务启动的时候，找到所有已经提交的事务 ID 的最大值，记为 up_limit_id。<br>    --  这个up_limit_id 是否可以理解为 是 最接近低水位的成功提交的 trx_id  （考虑还有回滚的，所以不一定是 减1的值）<br><br>=== <br><br>问题2:<br>如果落在黄色部分，那就包括两种情况 <br>a. 若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见<br>b. 若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见<br>  <br>-------------------<br><br>针对(a)， RR和RC都能理解;<br>针对(b)， RR 应该也是认为不可见吧，因为已经 row trx_id &gt; up_limit_id了， 而RC能可见是不是因为 在事物启动的一瞬间虽然 row trx_id 还未提交，但是当执行到某个语句时，对应的row trx_id已经提交了，所以能可见。<br> <br>因此，图3中黄色部分的未提交数据，是否理解为事物启动时的视图，在RC下，随着事物的执行，这些事物有可能会变成提交状态，对应(b)的可见性<br><br>望老师解答。感谢！<br><br><br><br><br></div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">1. 摒弃那个吧😄 我都觉得绕了<br>2. 你的理解是对的，但(a)和(b)的定义不同改。因为我们说的是跟“视图数组”的对比，而RR的视图数组是在事务启动的时候创建的，之后不会改了</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/9f/1d/ec173090.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">melon</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师有一点不太明白，当前事务自己生成的为什么会落在绿色部分呢？当前事务的ID应该是大于或等于低水位的，为什么不是落在黄色部分呢？</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">单独绿色的字和绿色的线标出来了😄</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/77/fd/c6619535.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">XD</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">看明白了，辛苦老师！</div> <span class="time">2018-12-03</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/fe/c1/6c99fff4.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Jason_鹏</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">“因为之后的更新，生成的版本一定属于上面的 2 或者 3(b) 的情况，而对它来说，这些新的数据版本是不存在的，所以这个事务的快照，就是“静态”的了”这块是不是应该改成“生成的版本一定属于上面的2或者3（a）”</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">对… 谢谢，我更新下… 我这手残😓 </p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/e7/7b/71da8283.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">似水流年</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">原文”如果落在黄色部分，那就包括两种情况<br>a. 若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见；<br>b. 若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见。”中，b段落，为什么row trx_id不在数组中，不是未来提交事务，而不是已提交事务？这个row trx_id如果是已提交事务，怎么又在黄色区域，不在绿色已提交区域？</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">在黄色区域是因为，这些事务是在“低水位事务之后”开启的，但是又在“当前事务启动前”提交的</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/80/da/9c0c458c.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">安静</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">这篇讲清楚了所有事物隔离级别的原理。</div> <span class="time">2018-12-03</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/f6/c8/d89de7c4.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">潘健</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师重新改写了一遍啊，辛苦，精益求精啊。    1.up-limit-id概念没了，用低水位，高水位来代替了。<br>2.增补了一个场景，当前正在执行的事务中存在的row trx-ID也不可见。<br>3.还增加了事务c&#39;场景，加了个锁等待。<br>感觉第二版比第一版知识量还多啊，大概是先入为主的概念，我怎么还是觉得第一版的uo-limit-id更好理解呢！</div> <span class="time">2018-12-03</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/59/8c/1958aa8f.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">void</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，有没语句能看到up-limit-id。和read-view</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">没有😄</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/59/8c/1958aa8f.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">void</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">从测试中看 innodb的事务id 应该是第一条sql后才分配的。而不是begin 时候分配的。</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">试一下 start transaction with consistent snapshot 验证文章中的结论哈，这样印象更深刻</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/bc/0d/00424e81.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">到道可道</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">这是由于采用begin显示声明了一个事务，在本次事务没结束前，在本事务内做的查询操作，都是对事务开始前的版本的查询，可以加for update或共享锁的当前读来获取最新的值。</div> <span class="time">2018-12-03</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">对的，可重复读是这样</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/77/fd/c6619535.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">XD</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，在整理的时候又发现一个问题，请指导一下。<br>如果在A启动之前有另外一个事务D没有提交， 它的trx_id为98, 在Q1之后，它进行了提交，操作也是k=k+1，那这一行的最新的记录应该是{v:4, trx_id:98}。这么一来，当进行Q2操作的时候，读取到的row trx_id为98, 小于事务A的trx_id100。那这个时候是不是就要的起了呢？</div> <span class="time">2018-12-02</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">你现在看一下09篇的“课后问题时间”哈</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/51401220.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">小美</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">原文：【好，现在事务 A 要来读数据了，它的 up_limit_id 是 99。当然了，读数据都是从当前版本读起的。所以，Q2 的读数据流程是这样的：<br>  ● 找到 (1,3) 的时候，判断出 row trx_id=101 大于 up_limit_id，要不起；<br>  ● 接着，找到上一个历史版本，一看 row trx_id=102，还是要不起；<br>  ● 再往前找，终于找到了（1,1)，它的 row trx_id=90，是可以承认的数据。】<br>问题：林老师，假设事务C执行完后，来了一个事务D：查询select k from t where id = 1;查询执行两次，一次在B事务提交前，一次再B事务提交后，此时D得到的up_limit_id=102，第一次查询时，得到的k=2，第二次查询时，事务B已经提交了，那up_limit_id=102,row trx_id=101,所以读到了B提交以后的结果，即第二次k=3，同一个事务两次读取结果不一致。我这个逻辑哪里有问题呢？</div> <span class="time">2018-12-02</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">其实规则里面还有一个活跃事务判断。<br><br>本来要留着下一篇说的…<br><br>后面发现这篇的描述规则不好人工判断，<br>我把08篇重写了，你再看下😄</p> <p class="reply-time">2018-12-02</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJAibnPX9jW8kqLcIfibjic8GbkQkEUYyFKJkc39hZhibVlNrqwTjdLozkqibI2IwACd5YzofYickNxFnZg/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Sinyo</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">第二个有效更新是事务 B，把数据从 (1,2) 改成了 (1,3)。这时候，这个数据的最新版本（即 row trx_id）是 101，而 102 又成为了历史版本。<br><br>老师，请问这里102不是最大的row trx_id吗？如果最大即最新，那么前面事务A的Q2读到的还是102吗？</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">一致性读下A一直读的是90这个版本的</p> <p class="reply-time">2018-12-02</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/44/2f/42a8d353.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">王宝龙</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">刚开始没注意作者说要复现，以为这是一个固定的知识点，于是根据作者正片篇文章的知识点来做步骤分析，但思来想去，依然无解。于是开始查看评论的答案，看到了置顶评论，然后依据他的思路进行了复现，果然效果浮现了，同时，思路也明朗了。<br><br>**复现思路**：在事务期间，开启另外一个客户端，执行“update set c=c+1 where id=c”，此时所有的值修改了，就会出现作者问题中的效果。<br><br>那么我就来班门弄斧，详细分析一下问题的解题思路。<br><br>1. 开启事务，创建一致性视图，假定分配的 transaction id 为 101，up_limit_id 为 100。<br>2. 在第一次 select 时，数据未修改，则会看到1、2、3、4。<br>3. 在执行更新前，先去开启另一个客户端，执行 SQL 对每一行的 c 累加 1（假定该更新的事务的 transaction id 为 102）。<br>4. 再在当前事务中，执行更新。更新操作是遵循“当前读”规则，此时实际的数据已更新，并且每一行（row）的 trx_id 为 102，那么 id=c 的条件判断，则无法匹配到任何行，以至于最终得到的结果是影响行数为 0。<br>4. 由于是事务隔离级别是 RR（Repeatable Read）可重复读规则，而 select 遵循的是“一致性读”规则。所以，在执行 select 查询时up_limit_id 为 100，而每一行版本已经成为了 102，所以会根据 undo log 计算版本回退为 100 时的数据，最终你看到的数据依然是 1、2、3、4。</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">👍🏿<br><br>从评论区获得灵感很棒</p> <p class="reply-time">2018-12-02</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/a0/da/4f50f1b2.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Knight²º¹⁸</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">本来看完第一遍认为自己理解了，结果看完评论区的留言，懵逼了。果断再看了一遍，敲了几行sql，再到纸上上画了几篇，这会儿总算理解了评论区其他童鞋问的问题了。</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">一波三折呀😄</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoVHWQP5bIygys4Ou6ibyED9b8PUt5CqYZxhMKWMLlVWl3xGGJO32exHuZs16ROCssmM77KicXXT6gw/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">鲁旭光</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">看图1，根据MDL特性，事务A开启了读锁，事务B开启了读锁，事务A和事务B都是读锁，不互斥，但是到事务C开启了写锁，读写互斥，事务C应该进入锁等待，事务C的更新操作，应该等事务A和事务B提交后才能执行吧。为什么事务C的更新操作先执行了呢？<br>请老师解惑下，多谢！</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">对数据的增删改查都是MDL读锁，<br><br>06篇再细看下？</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/4e/3a/2aa0f5cf.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">linqw</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">学习总结：<br>1、不可重复读，相对于update和remove，幻读是相对于insert<br>2、mvcc只能在rc及rr级别下才能使用，mvcc在数据行增加隐藏列（undo log指针，事务版本号（数据行的当前事务版本和当前行的删除版本）），在事务进行删除时，更新删除版本号，update时将其数据写入undo log中并且更新当前事务版本，更新undo log指针<br>3、rr级别下，在开启事务时将其当前数据行的最新版本号更新到up_limit_id变量中，up_limit_id事务已经结束的版本号，比如88事务已经停止，89事务对其行进行更新过，但是89事务还未提交，为此需将其up_limit_id保存为88，防止89对数据行进行更新，导致不可重复读，up_limit_id变量只能在自身事务对其数据行进行更新时，才将其改变为自身的事务版本号，select是快照读，除了for update（需要获取x锁），读取的数据行只能是行的系统版本号小于up_limit_id或等于事务的系统版本号），这样可以确保事务读取的行，要么是在事务开始之前已经存在，要么是事务自身插入或修改的数据，行的删除版本要么未定义，要么大于当前事务版本号，这可以确保事务读取到的行，在事务开始之前未被删除，由于当前行存放的是最新的版本号，为此需根据其undo log获取数据行，当前读是需要获取x锁，为此读取到的数据是最新的数据，当一个事务要对其一行进行更新时，需获取x锁，读取到的数据是最新的数据，rr级别存在幻读在select级别mvcc不会出现幻读，当前读，根据next-key锁，行锁和gap锁，在一定上下范围解决了幻读<br>3、rc级别由于每次执行sql时，都会重新计算up_limit_id，读取到的数据都是最新的数据，存在不可重复读<br>4、undo log中的数据什么时候？当没有事务再需要它的时候，就可以删掉，即事务中的up_limit_id都大于此数据中的版本号<br>5、思考题，和java中的cas，判断内存中的数据是否是预期的数据，如果是就更新，如果不是证明数据已经过期，事务基于数据行版本，更新数据时，如果当前行的版本号大于事务的版本号，另起事务进行重新更新，有点感觉像自旋锁的味道，如果更新失败，先把值值，读取出来，然后在重新更新，不知道老师我理解的对不对</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">嗯，这是一种做法的，分析得挺好</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/e9/0b/53bf91d3.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">WL</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">思考题: 因为更新是当前读, 所以如果有另外的事务先执行了一次更新操作, 本事务在执行的时候就会根据的值进行判断和更新, 于是可能就会出现无法更新的情况. </div> <span class="time">2018-12-01</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/c4/3a/a92cb97b.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">FW _UI</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">没有复现的同学，记得不要用begin而是改用start transaction.<br>是不是只有老师才有回复的权限？</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">Begin和start transaction是一样的<br><br>如果要马上启动事务，是start transaction with consistent snapshot</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">往事随风，顺其自然</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">执行事务B的Q1语句时候，一看自己版本好是101，最新数据版本号不是102？是在事物C基础上读到新的值。上面描述是不是错了</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">执行Q1的时候，事务B已经更新过了，(1,3)已经生成出来了</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">往事随风，顺其自然</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">row trx-id不是小的才会成为历史版本？难道这个id大小没关系？</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">历史版本的意思就是“有人更新了，产生一个新版本，原来的版本就变成历史版本”</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">往事随风，顺其自然</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">transaction-id 和row Trx-id 两者值应该一直是相等的吧</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">不会肯定相等，你想下如果有多个事务一起读同一行… </p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">天王</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">mvcc的实现原理，一行数据有多次更新，一次更新操作都有一个事务，事务id是申请的，递增的叫做transactionid。每一次修改都会有一回滚日志undolog，多个版本就是通过undolog计算出来的。每一次修改都会有一回滚日志undolog，多个版本就是通过undolog计算出来的。</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">嗯嗯，把这些名词和他们的逻辑理得很清楚呢😄</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/00/4e/6a23251c.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">小智e</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">这一篇文章非常厉害了，值了值了</div> <span class="time">2018-12-01</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">发条橙子 。</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师 ， 看了@约书亚 的回答还有个疑问点 。 说到另起一个事务在 当前事务update前 先修改掉 <br><br>问题 ：<br><br>另起一个事务在当前事务更新前修改 ， 如果新起的事物没有提交 ，那么当前的事物没有办法执行更新语句 ，会一直堵塞。<br>如果新起的事物提交后 ，当前事务再更新，那么当前事务更新的数据行是最新的 ，再去查询也应该是当前事务更新的值<br><br>所以为什么会看不到新的值还是没有理解😞</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">当前事务再更新，成功了的话，就是就是看到自己更新的，<br><br>自己更新生成的版本自己是要可见的（transaction_id=row trx_id)</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">往事随风，顺其自然</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">这个要是有案例操作现象操作就好了，会更易理解。</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">额，开头的三个事务就是操作现象呀，你是希望什么样的，给我举个例子。如果能更方便说明问题，后面文章我好参考着写</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJia2mqq4pWHVYtN9fXZ91iajnE0ib3JqQejD9oo7kusbY64uDPrib1yOBzowoFCA4ORHUDF3HEWCZIMQ/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">perkyoung</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">图一，在 RR 隔离级别下，如果 begin 下面不紧跟着一个 select 语句，那 Q2的结果应该是3，所以视图应该是在事务的第一个查询语句的时候创建的，而不是事务一启动就创建了，我的 mysql 版本是5.1.73；望指教。</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是的，事务并不是在begin启动的，而是begin 之后的第一个语句，才算事务启动</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">往事随风，顺其自然</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">很多没有说清楚，哪个先提交，row Tex-id和up-limit-id 有什么区别？是不是两者都要比较再去读或者更新</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">额，<br>Row trx_id 是行上的， up_limit_id是事务视图的<br><br>你再看看？</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">往事随风，顺其自然</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">这里是c先提交的事物，然后b，在是a？</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">表格里面从上到下是时间顺序</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">发条橙子 。</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">这篇文章细节满满 很多模棱两可的疑问不攻自破了 受益匪浅 。 谢谢老师 🙏</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">希望重写的版本可以解决更多😄</p> <p class="reply-time">2018-12-03</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">往事随风，顺其自然</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">事物A开始之前up-limit-time 是99，对应这个数据的k值是多少？你为啥还是取row Trx-Id为90的k的值，不应该是99对应k值？</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">在这个题目背景里，99这个事务没有更新这一行的 😓</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/70/cc/a99b8bf9.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">绵呀绵</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师请教一个问题，有个表A里面有300条数据，每次alter 增加字段都会卡住，一直执行不了，然后导致后面查询A表的请求全部锁死了，只能强制断开alter增加字段操作，手动删除锁死的请求pid，请问，理论上我执行alter表的时候，会锁住整个表但数据才300条应该很快就更新完成了，为什么一直卡住。</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">你再看一遍06篇呗😄<br><br>如果还没理解，把你被锁住后的show processlist发出来</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Justin</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">有个问题 如果commit之前就生成了历史版本，当前版本的记录，那么如果之前的一个update没有commit，没有释放锁，那后来新的一个事务select会不会因为那一行还有锁而提取全表数据等待呢？一致性读的时候读不是不加锁的吗？那这种情况怎么办呢？</div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">一致性读的时候，只有未提交的版本都直接认为不可见（包括可重复读隔离级别和读提交隔离级别）</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/9a/f2/64d1c380.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">📆</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师你好，我想问下，我用的mysql5.7，最后成功改成0了，是有哪里不对吗？<br>mysql&gt; begin;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql&gt; select * from t;<br>+----+------+<br>| id | c    |<br>+----+------+<br>|  1 |    1 |<br>|  2 |    2 |<br>|  3 |    3 |<br>|  4 |    4 |<br>+----+------+<br>4 rows in set (0.00 sec)<br><br>mysql&gt; update t set c=0 where c=id;<br>Query OK, 4 rows affected (0.01 sec)<br>Rows matched: 4  Changed: 4  Warnings: 0<br><br>mysql&gt; select * from t;<br>+----+------+<br>| id | c    |<br>+----+------+<br>|  1 |    0 |<br>|  2 |    0 |<br>|  3 |    0 |<br>|  4 |    0 |<br>+----+------+<br>4 rows in set (0.00 sec)<br></div> <span class="time">2018-12-01</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">表示你还没有复现题目的现象，可以参考一下评论区其它答案哦</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/de/2b/2702fcbe.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">jimmy</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，问个问题，一个历史row版本可以删除的依据是什么，您文中提到的是没有事物再使用这个版本了，感觉这句话还是很空洞，能不能具体说一下？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">如果所有事务的一致性读的结果，都不需要再用到它的时候。<br><br>比如我们例子中，Q2执行前， row trx_id=101 102的两个版本，就不能删除，因为事务A还需要依赖他们</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">风雪</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师临时表怎么避免，我已经用join和注意使用第一张表的列了</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">其实临时表不能完全避免，不过如果只是两表join应该还是可以的<br><br>贴一下你的表结构和查询语句</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/fe/75/46742f12.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">liao xueqiang</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">那么，它在读到（1,3) 的时候，就满足了 up_limt_id(102) ≥row trx_id(101) 的条件，所以返回了 k=3。<br>这有问题吧，101是最新版本，102是历史版本啊。应该up_limt_id(101) ≥row trx_id(102) 吧</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">（1，3）的row trx_id 是等于101的呀，事务B更新产生的</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/f7/69/d8dba3de.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">DanielAnton</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">那么，它在读到（1，3）的时候，就满足了 up_limit_id（102）&gt;= row trx_id（101）的条件，所以返回了 k = 3。事务 A 的 row trx_id 不应该是 100 吗？所以应该是 up_limit_id（102） &gt;= row trx_id（100）吧。</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">注意，row trx_id 是“数据版本”才有的概念（名字里故意加了个row )，up_limit_id才是事务的<br><br>你再重新理解下哈</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/fd/c8/5aa7ae1b.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">李金刚</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">和 @夏日雨 一样的问题。<br><br><br>老师你好，有个问题不太理解，对于文中的例子假设transaction id为98的事务在事务A执行select（Q2）之前更新了字段，那么事务A发现这个字段的row trx_id是98，比自己的up_limit_id要小，那此时事务A不就获取到了transaction id为98的事务更新后的值了吗？<br>换句话说对于文中&quot;之后的更新，产生的新的数据版本的 row trx_id 都会大于 up_limit_id&quot;这句话不太理解， up_limit_id是已经提交事务id的最大值，那也可能存在一个没有提交的id小于up_limit_id的事务对数据进行更新？还是说transaction id比up_limit_id小的事务都是保证已经提交的？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">看置顶回答哈</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/fd/c8/5aa7ae1b.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">李金刚</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">和 @夏日雨 一样的问题。<br><br><br>老师你好，有个问题不太理解，对于文中的例子假设transaction id为98的事务在事务A执行select（Q2）之前更新了字段，那么事务A发现这个字段的row trx_id是98，比自己的up_limit_id要小，那此时事务A不就获取到了transaction id为98的事务更新后的值了吗？<br>换句话说对于文中&quot;之后的更新，产生的新的数据版本的 row trx_id 都会大于 up_limit_id&quot;这句话不太理解， up_limit_id是已经提交事务id的最大值，那也可能存在一个没有提交的id小于up_limit_id的事务对数据进行更新？还是说transaction id比up_limit_id小的事务都是保证已经提交的？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">看置顶回答哈</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/8f/ad/6e3e9e15.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">产品助理</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">提醒一下，自己看到前面的时候进行测试，发现执行结果与老师分享的不一致，困惑了一下。<br><br>后想到当前要求是：可重复读的场景下，于是检查事务隔离级别：<br><br>SELECT @@tx_isolation; <br><br>结果却是 READ-COMMITTED 读提交。。<br><br>所以调整后就可以了：set global  TRANSACTION ISOLATION LEVEL REPEATABLE READ;<br><br>-- 执行后记得重新连接Mysql。</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">嗯嗯，检查环境是好习惯，也可以不加global，这样本连接直接生效哦</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/fd/c8/5aa7ae1b.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">李金刚</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">和@周巘 一样的问题。<br><br> 老师好 我想请问一下 如果文章中99号事务提交了 98号事务还没有提交 那么这三个事务的up_limit_id应该还是99 然后在事务A(id=100)的两次读过程中 98号事务提交并且修改了这一行 此时row trx_id=98 将会小于up_limit_id=99 那么事务A的两次读请求结果不就不一样了吗? 请老师解惑 谢谢</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">看置顶回答哈</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/46/48/e959b1e0.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">amazon1011</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">请问最大事务ID是保存在系统里面的一个全局变量吗?是excution_gtid?如果并发写很大，这个产生事务id的生成器会不会成为瓶颈?</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是全局变量，事务启动后拷贝为这个事务自己的内部变量的<br><br>不是gtid 哈，trx_id是innodb 的机制，gtid 是server 层的</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/d5/ee/762ca3f9.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">🚶🏻_____路人丙</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师你好，请问图3假设第三点，三个事务开始之前，这一行得数据row trx_id为啥就是90？这个值是如何得到的？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">假设呀… </p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIqWaVic6yGdicbM2ca4KaJLo3oVtxnpea9hb2zMKSvM2UNiadF5l3PW88QJibcKiaf5b61c0cVa72ZYjw/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">杜明欣</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">对于一行数据来讲，数据版本大的对应的事务id不一定是最大的，这个是否会有什么影响</div> <span class="time">2018-11-30</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/4c/49/4c5bc84f.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">mazhen</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">分布式数据库TiDB实现了可重复读隔离级别，但它没有“当前读”这个概念，参看它的文档：<br><br>“与MySQL可重复读隔离级别的区别”  https:&#47;&#47;pingcap.com&#47;docs-cn&#47;sql&#47;transaction-isolation&#47; <br><br> TiDB在事务中的update语句也用的是snapshot版本，而不是“当前读”。<br><br> 老师如何评价TiDB的这种实现方式？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">库淘淘</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">session 1;<br>begin;<br>select * from t;<br>+----+------+<br>| id | c    |<br>+----+------+<br>|  1 |    1 |<br>|  2 |    2 |<br>|  3 |    3 |<br>|  4 |    4 |<br>+----+------+<br><br>session 2;<br>update t set c=0 where id=c;<br>Rows matched: 4  Changed: 4  Warnings: 0<br><br>session 1;<br>update t set c=0 where id=c;<br>Query OK, 0 rows affected (0.00 sec)<br>Rows matched: 0  Changed: 0  Warnings: 0<br><br>select * from t;<br>select * from t;<br>+----+------+<br>| id | c    |<br>+----+------+<br>|  1 |    1 |<br>|  2 |    2 |<br>|  3 |    3 |<br>|  4 |    4 |<br>+----+------+<br>原理：是可重复读隔离级别下，<br>session1 中因update 当前读 发现没有适合条件的更新，未更新成功，<br>select 读继续保持最开始select快照；<br><br>解决方案 可以再事务update语句后面加入 commit work and chain;</div> <span class="time">2018-11-30</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/cb/ab/1aac53bf.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">董航</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">个人觉得，吧read-view理解为当前活跃事务表就好理解了，网上看到的一篇写的还行<br>https:&#47;&#47;skydh.github.io&#47;2017&#47;12&#47;27&#47;mysql%20%E4%BA%8B%E5%8A%A1%EF%BC%8C%E9%94%81%EF%BC%8C%E4%B8%8E%E5%9B%9B%E5%A4%A7%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB&#47;</div> <span class="time">2018-11-30</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Justin</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">有个问题 ，是不是只有commit了之后的数据才会被加到有历史版本和当前版本的记录中呢 没有commit 是不是就是自己知道 存在内存的某个角落呢？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">好问题，<br><br>没commit也写，也生成版本，但是是未提交的，还加着锁。<br><br>正文再引入这个大家看晕了，偷偷没提。</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/04/fb/40f298bb.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">小罗希冀</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">ABC事务 的流程图，那个语句是Q1，那个是Q2，Q3？看的有点晕，就是这里看不懂，经常在下文中看到这些Q1、Q2、Q3都有一种不知所云的感觉</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">我去确认了一下图，都标出来了呀</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/0f/7d/95/6b0c334b.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">刘-阿-伟</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">早！老师有什么办法能模拟你文章的例子。</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">就是开三个客户端按顺序模拟呀</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/33/cc/2c73c8c4.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">fery</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，请问我可以请教一个问题吗？存储过程统计历史数据的每天数据，使用insert   into  select (可能会多张表，有的是大表)  ，会造成死锁吗？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">单线程跟自己是不会死锁的<br><br>另外对你描述的这个背景有点疑惑，统计历史数据每天的数据，为什么用 insert into select. ?</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/12/79/b7/989824f7.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">春困秋乏夏打盹</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">session1 更新失效，是session2在更新提交之后，session1的update是当前读，读到id=c的不存在，所以更新失败</div> <span class="time">2018-11-30</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/f7/ad/4a5acd62.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">帅子</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">思考题，好像不符合预期，mysql5.7，有点疑惑<br>mysql root@127.0.0.1:test&gt; select @@transaction_isolation;<br>+---------------------------+<br>| @@transaction_isolation   |<br>|---------------------------|<br>| REPEATABLE-READ           |<br>+---------------------------+<br>1 row in set<br>Time: 0.002s<br>mysql root@127.0.0.1:test&gt; desc test;<br>+---------+---------+--------+-------+-----------+---------+<br>| Field   | Type    | Null   | Key   |   Default | Extra   |<br>|---------+---------+--------+-------+-----------+---------|<br>| id      | int(11) | NO     | PRI   |    &lt;null&gt; |         |<br>| c       | int(11) | YES    |       |    &lt;null&gt; |         |<br>+---------+---------+--------+-------+-----------+---------+<br><br><br>mysql root@127.0.0.1:test&gt; begin;<br>Query OK, 0 rows affected<br>Time: 0.001s<br>mysql root@127.0.0.1:test&gt; select * from test;<br>+------+-----+<br>|   id |   c |<br>|------+-----|<br>|    1 |   1 |<br>|    2 |   2 |<br>|    3 |   3 |<br>|    4 |   4 |<br>|    5 |   5 |<br>+------+-----+<br>5 rows in set<br>Time: 0.002s<br>mysql root@127.0.0.1:test&gt; update test set c=0 where id=c;<br>Query OK, 5 rows affected<br>Time: 0.002s<br>mysql root@127.0.0.1:test&gt; select * from test;<br>+------+-----+<br>|   id |   c |<br>|------+-----|<br>|    1 |   0 |<br>|    2 |   0 |<br>|    3 |   0 |<br>|    4 |   0 |<br>|    5 |   0 |<br>+------+-----+</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">参考一下其它评论的复现步骤</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">库淘淘</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">读提交隔离下。 这时，事务 A 的 Q2 语句开始执行的时候，由于事务 B（101）、C（102）都已经提交了，所以 Q2 的 up_limit_id 的值就应该是事务 C 的 transaction id，即 102。  这个有个疑问 up_limit_id不应该是最后提交的 事务B(101)吗 为何是最先提交的 102呢</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">规则就是“找最大的”😄</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/18/07/c0a73a52.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">憶海拾貝</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">看似更新不了,实际上是更新语句执行时(当前读)读到的数据, 与查询语句执行时(快照读)读到的数据不同所致.<br>只需要在更新语句执行前, 开启另一个事务破坏`id=c`条件. 比如执行`update t set c=id+1`提交即可.<br><br>解决方式, 可以直接用`select...for update`来查询, 先加锁再读.<br><br>构造场景的时候想到一个问题, InnoDB的行锁什么情况下会升级为表锁?</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">分析不错，不过 For update对业务并发度影响比较大哦<br><br>“锁一个表的所有行” 还是行锁蛤，<br><br>如果这么定义，应该不会这么升级吧？</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/30/28/6e019a7a.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">锅子</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">思考题<br>session1                                                        session2<br>begin;<br>select * from t;<br>                                                    update t set c=100 where id=c;<br>update t set c=0 where id=c;<br>select * from t;</div> <span class="time">2018-11-30</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/16/31/ae8adf82.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">路过</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">在5.7.24中测试今天的思考题，结果是c都变成了0。和您贴出的结果不同。没有想明白为什么。</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">表示你没有复现这个情况哈</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/6f/9f/71fa279a.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Geek_7c1218</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">对于可重复读，查询只承认在事务启动前就已经提交完成的数据；<br><br>这个应该是第一次查询时 不是事务启动时吧</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">Begin不算事务启动哦，所以咱们俩是一致的</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/91/b1/b56e800e.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">w</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，我是那个提问mysql 5.5, 5.7, 8.0 问题的人。具体的参数太多了，这里贴不下。有没有需要重点贴出的参数呢？或者是否给我个什么命令然后我执行一下后把结果发给您。</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">你找个地方把复现过程写一下，这里贴地址。 GitHub 或者博客、长微博都可以</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">keepmoving</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">在可重复读隔离级别下，事务在启动的时候就“拍了个快照”。<br>老师，这句话有点疑问，在可重复读隔离级别下，事务视图应该是在事务第一个查询执行时建立的吧，在下面这个例子中<br>demo1<br>A1: start transaction;<br>A2: select * from t;<br>         B1: start transaction;<br>         B2: insert into t values (4, wangwu);<br>         B3: commit;<br>A3: select * from t;<br><br>demo2<br>A1: start transaction;<br>         B1: start transaction;<br>         B2: insert into t values (4, wangwu);<br>         B3: commit;<br>A2: select * from t;<br><br>demo1的A3和A2读到的数据是一样的即读不到B事务新插入的数据，但是demo2里的A2却可以读到B事务新插入的数据，能解答一下么？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">我跟你是一致的，<br><br>如果是 begin; select ... 这种用法，<br><br>事务是在select语句才正式启动</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/10/77/fd/c6619535.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">XD</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">感觉可以理解成，只要操作需要对记录加锁，他就会使用当前读。那么这个加锁的过程到底是怎么样的呢，锁是存放在内存里的吗？这块后续还会有专门讲解吗？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">在内存里，专门有个地方存锁信息，“这一行现在是我的了”，类似这样的信息</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/01/29/11c1c2f7.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">姜磊</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师你好，关于上期的问题，假设我的T表很大，第一种方法只需要全表扫描一次，第二种需要全表扫描20次吧？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">有Limit ，都是总共锁10000行</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="" class="avatar">
<div class="info">
	<div class="hd"><span class="username">suke</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师，在重复读级别下，b事务中，执行update t set k=k+1 where k=1这句时，where条件中得到的k=1 ，k+1以后，不应该是2，么，为什么是3，您的文章里说，如果是2，c事务就失效了，所以 执行where语句和执行k=k+1不是在同一个逻辑一致性下执行的？那这样可重复读的语义是不是没有保证？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">Update语句是“当前读”的逻辑，所以它拿到的k 是2哦<br><br></p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/de/7b/49810dd8.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">live</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">显然地，语句 Q1 的查询结果 k=1，哈哈，这里我想了半天，也应该是3啊，原来大家都有此疑问</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">尴尬😅 赞大家细致</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/14/0b/70/a2c1723c.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">武者</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">可重复读 需保证查询前后一致<br>我一直认为这是相对其他查询的<br>当前的提交和查询都在一个事物里怎么还查不到变化的结果</div> <span class="time">2018-11-30</span>
	<div class="reply">
	
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/ec/01/978d54af.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Justin</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">请问可重复读会给行加锁吗</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">你要问的应该是一致性读， 不加</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/31/fe/30a17a9d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Leo</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">文中说: “读提交是在每条语执行前计算up_limit_id”，如果不计算会怎样？就变成了读未提交吗？</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">… 为啥不提交，bug 吗 😄<br><br>无关不计算也不判断，就是读未提交；<br>如果不计算，但是判断，那就是用事务的up_limit_id, 就是可重复读</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/13/de/29/71685b0b.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">BigMortal</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">##思考题：<br>#问题复现：<br>session 1：                                        session2：<br>t1:begin：(up_limit_id1)<br>t2:select * from t;                                t2:begin;  (up_limit_id2)<br>                                                        t3:update t set c=0 where id=c;  <br>                                                        t4:commit                                                        <br>t5:update t set c=0 where id=c; (need             <br>t6:select * from t;  <br>#原理：<br><br><br>                               </div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">继续哈🤝</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="https://static001.geekbang.org/account/avatar/00/11/31/fe/30a17a9d.jpg" class="avatar">
<div class="info">
	<div class="hd"><span class="username">Leo</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">老师在文中说: &quot;所以，在执行事务 B 的 Q1 语句的时候，一看自己的版本号是 101，最新数据的版本号也是 101，可以用，所以 Q1 得到的 k 的值是 3。&quot;，<br>1. 这里不参考up_limit_id吗？<br>2. 如果参考，事务B的up_limit_id是在update语句执行前重新计算的，还是在Q1语句执行前重新计算的？<br></div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是自己更新的，就不用比了</p> <p class="reply-time">2018-12-01</p>
	</div>
</div>
</li><li data-v-87ffcada="" class="comment-item"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/AwEHMTGSmVsia3WZDyIicBQPAfS11lBZ0yUappicPzfmGDmMwkje1UoqKK3UJ6FCBdsZyiauuV1SEfcrFzWfx9n1RQ/132" class="avatar">
<div class="info">
	<div class="hd"><span class="username">虚爱凯平</span>
	<div class="control">
		 <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span>0</span></a></div>
	</div>
	<div class="bd">最后读提交隔离级别下, Q1的查询结构应该是k=3吧?</div> <span class="time">2018-11-30</span>
	<div class="reply">
	<div class="reply-hd"><i class="iconfont"></i> <span>作者回复</span></div> 
	<p class="reply-content">是的… 抱歉写错了，已经发起修改</p> <p class="reply-time">2018-11-30</p>
	</div>
</div>
</li></ul></div></div></div></div><div id="translate-man-app" class="content-3WfBL_0" style="background-color: rgb(255, 255, 255); display: none;"><div data-v-ea0bd11e="" class="outputBox-qe9A4_0"><div data-v-ea0bd11e="" class="outputBox-3oESn_0"><span data-v-ea0bd11e="" class="outputBox-13Ovx_0"></span></div><div data-v-ea0bd11e="" class="outputBox-1GLb__0"><div data-v-ea0bd11e="" class="outputBox-onVZH_0"><img src="chrome-extension://fapgabkkfcaejckbfmfcdgnfefbmlion/static/sound.svg"            class="icon-tprjJ_0"></div></div><div data-v-ea0bd11e="" class="outputBox-2sJgr_0"></div><div data-v-ea0bd11e="" class="outputBox-17RAm_0" style="display: none;"><div data-v-ea0bd11e=""></div></div></div></div><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({        showProcessingMessages: false,        messageStyle: "none",        tex2jax: {          inlineMath: [['$','$'], ['\\(','\\)']],          displayMath: [ ["$$","$$"] ],          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'a']        }      });      MathJax.Hub.Register.MessageHook("End Process", function (message) {        var eve = new Event('mathjaxfini')        window.dispatchEvent(eve)      })</script></body></html>